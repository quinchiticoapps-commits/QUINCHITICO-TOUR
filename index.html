```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quinchitico Tour - Planificador con Supabase</title>
    <!-- Iconos Font Awesome (Del cÃ³digo original) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cliente de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        /* --- ESTILOS ORIGINALES --- */
        :root {
            --primary: #00cec9;
            --primary-dark: #00b894;
            --secondary: #0984e3;
            --accent: #fdcb6e;
            --danger: #ff7675;
            --dark: #2d3436;
            --light: #f5f6fa;
            --white: #ffffff;
            --gray: #b2bec3;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: var(--light); color: var(--dark); padding-bottom: 100px; }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header h1 { font-size: 2rem; margin-bottom: 0.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { font-size: 1rem; opacity: 0.9; }

        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }

        /* --- DASHBOARD & SETUP --- */
        #dashboard-panel, #setup-trip-form, #connection-panel {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-top: -20px;
            text-align: center;
        }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-row { display: flex; gap: 1rem; }
        .form-row .form-group { flex: 1; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark); font-size: 0.9rem; }

        input, select, textarea {
            width: 100%; padding: 0.7rem; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 0.95rem; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-primary {
            background-color: var(--secondary); color: white; border: none; padding: 0.8rem 2rem;
            font-size: 1rem; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold;
            transition: transform 0.2s, background 0.3s; margin-top: 1rem;
        }
        .btn-primary:hover { background-color: #0769b5; transform: translateY(-2px); }

        .btn-secondary {
            background-color: var(--gray); color: white; border: none; padding: 0.6rem 1.5rem;
            font-size: 0.9rem; border-radius: 8px; cursor: pointer; margin-top: 1rem; margin-right: 10px;
        }

        /* Lista de Viajes en Dashboard */
        .trip-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .trip-card {
            background: #f8f9fa; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem;
            text-align: left; cursor: pointer; transition: 0.2s; position: relative;
        }
        .trip-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow); }
        .trip-card h3 { color: var(--dark); margin-bottom: 0.5rem; }
        .trip-card p { color: var(--gray); font-size: 0.85rem; margin-bottom: 0.2rem; }
        .trip-card-actions { position: absolute; top: 10px; right: 10px; }
        .btn-icon-small { background: none; border: none; color: var(--gray); cursor: pointer; padding: 5px; }
        .btn-icon-small:hover { color: var(--danger); }

        /* --- PANEL PLANIFICADOR --- */
        #planner-panel { display: none; animation: fadeIn 0.5s ease-in; }

        .trip-header-info {
            background: var(--white); padding: 1rem; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 1rem; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .trip-title { font-size: 1.3rem; color: var(--secondary); font-weight: 800; }
        .currency-info { text-align: right; font-size: 0.85rem; }
        .btn-back { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 20px; cursor: pointer; margin-right: 10px; }

        /* --- TABS & ACTIVITIES (Original styles kept) --- */
        .tabs-wrapper { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-top: 1rem; }
        .tabs-nav { display: flex; background: #f1f2f6; overflow-x: auto; border-bottom: 2px solid #dfe6e9; position: sticky; top: 0; z-index: 10; }
        .tabs-nav::-webkit-scrollbar { height: 4px; }
        .tab-btn { padding: 1rem 1.2rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--gray); white-space: nowrap; transition: 0.3s; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; min-width: 90px; }
        .tab-btn:hover { background: #e0e0e0; color: var(--dark); }
        .tab-btn.active { color: var(--primary); background: white; border-bottom: 3px solid var(--primary); }
        .tab-date { font-size: 0.75rem; font-weight: normal; margin-top: 2px; }
        .tab-content { padding: 1.5rem; }

        /* Styles for summary tab */
        .tab-btn.summary-tab { border-left: 2px solid #dfe6e9; margin-left: 5px; }
        .tab-btn.summary-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Activity List */
        .day-total-header { background: #e0f7fa; border: 1px solid #b2bec3; border-radius: 8px; margin-bottom: 1.5rem; text-align: left; overflow: hidden; }
        .day-title-section { background: #00cec9; color: white; padding: 0.8rem 1rem; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .totals-grid { padding: 1rem; display: flex; flex-direction: column; gap: 8px; background: white; }
        .total-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .currency-label { font-weight: bold; color: var(--dark); min-width: 50px; }
        .currency-values { text-align: right; font-size: 0.95rem; }
        .val-day { font-weight: bold; color: var(--secondary); margin-right: 10px; }
        .val-trip { color: var(--gray); font-size: 0.85rem; }

        .activity-list { list-style: none; margin-bottom:1.5rem; }
        .activity-item { display: flex; flex-direction: column; padding: 1rem; border-bottom: 1px solid #f1f2f6; position: relative; transition: background 0.2s; border-radius: 8px; }
        .activity-item:hover { background-color: #fdfdfd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .activity-top { display: flex; align-items: flex-start; gap: 1rem; }
        .activity-time { font-weight: bold; color: var(--secondary); min-width: 60px; font-size: 0.95rem; padding-top: 2px; }
        .activity-details { flex-grow: 1; }
        .activity-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 8px; }
        .activity-meta { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .activity-link { color: var(--secondary); text-decoration: none; font-weight: 600; }
        .activity-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 4px; }
        .btn-edit { background: #e0f7fa; color: var(--secondary); }
        .btn-delete { background: #ffebee; color: var(--danger); }

        .btn-add-activity { width: 100%; padding: 1rem; background: white; border: 2px dashed var(--primary); color: var(--primary); border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; margin-bottom: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
        .btn-add-activity:hover { background: #e0fffa; }

        .daily-expenses { background-color: #fdfdfd; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem; }
        .expense-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom:1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .expense-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .expense-input label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.2rem; }

        /* Summary Styles */
        .summary-card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .summary-title { font-size: 1.5rem; color: var(--secondary); margin-bottom: 1.5rem; font-weight: bold; }
        .big-totals { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-bottom: 2rem; }
        .big-total-item { flex: 1; min-width: 150px; padding: 1.5rem; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
        .bt-label { display: block; font-size: 0.9rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.5rem; }
        .bt-value { display: block; font-size: 1.8rem; font-weight: 800; color: var(--dark); }
        .bt-value.usd { color: var(--secondary); }
        .bt-value.crc { color: var(--primary); }
        .bt-value.local { color: var(--accent); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; text-align: left; }
        .breakdown-section h3 { font-size: 1.1rem; color: var(--dark); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #eee; }
        .breakdown-row { display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px dashed #eee; }
        .cat-name { font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .cat-val { font-weight: bold; color: var(--secondary); }

        /* --- FLOATING BAR --- */
        .floating-summary { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--dark); color: white; padding: 0.8rem 2rem; display: flex; justify-content: center; align-items: center; gap: 0.3rem; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); z-index: 100; }
        .floating-summary .total-amount { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .floating-summary .total-crc { font-size: 1rem; color: var(--primary); font-weight: bold; margin-left: 15px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom:1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }

        /* Supabase Connection Specific */
        #connection-status-badge {
            position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.3);
            padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #aaa; }
        .status-dot.connected { background: #2ecc71; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 2000; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #2ecc71; }
        .toast.error { border-left: 4px solid #e74c3c; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div id="connection-status-badge">
            <div class="status-dot" id="status-dot"></div> <span id="status-text">Desconectado</span>
        </div>
        <h1><i class="fas fa-plane-departure"></i> Quinchitico Tour</h1>
        <p>Planifica, guarda y sincroniza tus viajes</p>
    </header>

    <div class="container">

        <!-- 1. Panel de ConexiÃ³n Supabase -->
        <section id="connection-panel" style="display:none;">
            <div style="text-align:center; margin-bottom:1rem;">
                <i class="fas fa-database" style="font-size:3rem; color:var(--primary);"></i>
                <h2>Conectar Base de Datos</h2>
            </div>
            <div class="form-group">
                <label>Project URL</label>
                <input type="text" id="supa-url" placeholder="https://xyz.supabase.co" />
            </div>
            <div class="form-group">
                <label>API Key (Anon/Public)</label>
                <input type="password" id="supa-key" placeholder="eyJhbGciOiJIUzI1..." />
            </div>
            <button class="btn-primary" onclick="connectSupabase()">Conectar</button>
            <p style="font-size:0.8rem; color:var(--gray); margin-top:10px;">Tus credenciales se guardan en tu navegador.</p>
        </section>

        <!-- 2. Dashboard (Lista de Viajes) -->
        <section id="dashboard-panel" style="display:none;">
            <h2>Mis Viajes Guardados</h2>
            <p style="margin-bottom:1rem; color:var(--gray);">Selecciona un viaje para editarlo o crea uno nuevo.</p>
            
            <button class="btn-primary" onclick="showNewTripForm()">
                <i class="fas fa-plus"></i> Crear Nuevo Itinerario
            </button>

            <div id="trips-list-container" class="trip-list">
                <!-- Los viajes se renderizan aquÃ­ -->
            </div>
            
            <button class="btn-secondary" style="margin-top:2rem;" onclick="logoutSupabase()">
                <i class="fas fa-sign-out-alt"></i> Desconectar / Cambiar Cuenta
            </button>
        </section>

        <!-- 3. Formulario de Nuevo Viaje -->
        <section id="setup-trip-form" style="display:none;">
            <h2 style="margin-bottom: 1rem; cursor:pointer;" onclick="backToDashboard()">
                <i class="fas fa-arrow-left"></i> Crear Nuevo Viaje
            </h2>
            <form id="trip-form" onsubmit="handleCreateTrip(event)">
                <div class="form-group">
                    <label for="destination">Destino del Viaje</label>
                    <input type="text" id="destination" placeholder="Ej: ParÃ­s, Tokyo, Playa del Carmen" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Inicio</label>
                        <input type="date" id="start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">Fin</label>
                        <input type="date" id="end-date" required>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 1rem 0;">
                
                <div class="form-group">
                    <label>Seleccionar Moneda Principal</label>
                    <select id="preset-currency" onchange="fillCurrencyFromPreset()">
                        <option value="">-- O haz clic para seleccionar --</option>
                        <option value="USD|1">ðŸ‡ºðŸ‡¸ USD - DÃ³lar Americano</option>
                        <option value="MXN|18">ðŸ‡²ðŸ‡½ MXN - Peso Mexicano</option>
                        <option value="EUR|0.95">ðŸ‡ªðŸ‡º EUR - Euro</option>
                        <option value="COP|4200">ðŸ‡¨ðŸ‡´ COP - Peso Colombiano</option>
                        <option value="JPY|150">ðŸ‡¯ðŸ‡µ JPY - Yen JaponÃ©s</option>
                        <option value="GBP|0.8">ðŸ‡¬ðŸ‡§ GBP - Libra Esterlina</option>
                        <option value="CRC|540">ðŸ‡¨ðŸ‡· CRC - ColÃ³n Costarricense</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="currency-symbol">Moneda (SÃ­mbolo)</label>
                        <input type="text" id="currency-symbol" placeholder="$" value="$" required>
                    </div>
                    <div class="form-group">
                        <label for="exchange-rate">Tipo de Cambio (1 USD)</label>
                        <input type="number" id="exchange-rate" placeholder="Â¿CuÃ¡nto de tu moneda es 1 USD?" step="0.01" value="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="crc-rate">Tipo de cambio a Colones (1 USD = ? Colones)</label>
                    <input type="number" id="crc-rate" placeholder="Ej: 540" step="1" value="540">
                    <p style="font-size: 0.75rem; color: var(--gray); margin-top: 2px;">Necesario para calcular los totales en Colones.</p>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Crear y Guardar en Base de Datos
                </button>
            </form>
        </section>

        <!-- 4. Panel Planificador -->
        <section id="planner-panel">
            <div class="trip-header-info">
                <div>
                    <button class="btn-back" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i> Volver</button>
                    <div class="trip-title" id="display-destination">Destino</div>
                    <small id="display-dates" style="color:var(--gray)">Fechas</small>
                </div>
                <div class="currency-info">
                    <div>
                        <strong id="display-currency">USD</strong>
                        <button class="btn-edit-rate" onclick="openRateModal()" title="Editar tipos de cambio" style="background:none; border:1px solid #ccc; border-radius:4px; padding:2px 6px; cursor:pointer;">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <div>1 USD = <strong id="display-rate">1</strong> <small>(Local)</small></div>
                    <div>1 USD = <strong id="display-crc-rate">540</strong> <small>(Col)</small></div>
                </div>
            </div>

            <div class="tabs-wrapper">
                <nav class="tabs-nav" id="tabs-nav"></nav>
                <div class="tab-content" id="tab-content"></div>
            </div>

            <br><br>
        </section>

    </div>

    <!-- Barra Flotante -->
    <div id="summary-bar" class="floating-summary" style="display: none;">
        <div style="font-size: 0.8rem; text-transform: uppercase;">Total del Viaje:</div>
        <div class="total-amount" id="grand-total">$0.00 USD</div>
        <div class="total-crc" id="grand-total-crc">â‚¡0 Colones</div>
    </div>

    <!-- Modal Actividad -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">AÃ±adir Actividad</h3>
                <button class="close-modal" onclick="closeModal('activity-modal')">&times;</button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <input type="hidden" id="modal-day-index">
                <input type="hidden" id="modal-activity-index">
                <div class="form-group">
                    <label>CategorÃ­a / Icono</label>
                    <select id="act-icon">
                        <option value="fa-star">General</option>
                        <option value="fa-utensils">Comida</option>
                        <option value="fa-bus">Transporte (Bus/Taxi)</option>
                        <option value="fa-landmark">Museo / Cultura</option>
                        <option value="fa-plane">AviÃ³n / Viaje</option>
                        <option value="fa-bed">Hotel / Alojamiento</option>
                        <option value="fa-tree">Naturaleza / Parque</option>
                        <option value="fa-shopping-bag">Compras</option>
                        <option value="fa-glass-cheers">Fiesta / Noche</option>
                    </select>
                </div>
                <div class="form-group"><label>Hora</label><input type="time" id="act-time" required></div>
                <div class="form-group"><label>Nombre de la Actividad / Lugar</label><input type="text" id="act-name" placeholder="Ej: Visita al Museo" required></div>
                <div class="form-group"><label>UbicaciÃ³n</label><input type="text" id="act-location" placeholder="DirecciÃ³n o Punto de referencia"></div>
                <div class="form-group"><label>CÃ³mo llegar</label><input type="text" id="act-transport" placeholder="Ej: Metro Linea 3, Caminando 10min"></div>
                <div class="form-group"><label>Sitio Web (Opcional)</label><input type="url" id="act-link" placeholder="https://..."></div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="act-currency">Moneda</label>
                        <select id="act-currency">
                            <option value="local">Local</option>
                            <option value="usd">USD</option>
                            <option value="crc">Colones (CRC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-act-cost">Costo</label>
                        <input type="number" id="act-cost" min="0" step="0.01" value="0" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Guardar Actividad</button>
            </form>
        </div>
    </div>

    <!-- Modal Tipo de Cambio -->
    <div class="modal-overlay" id="rate-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Editar Tipos de Cambio</h3>
                <button class="close-modal" onclick="closeModal('rate-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Cambio USD a Local (1 USD = ? <span id="rate-modal-symbol"></span>)</label>
                <input type="number" id="new-exchange-rate" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Cambio USD a Colones (1 USD = ? Colones)</label>
                <input type="number" id="new-crc-rate" step="1" value="540">
            </div>
            <button class="btn-primary" onclick="saveNewRates()">Actualizar</button>
        </div>
    </div>

    <!-- SQL Helper Modal -->
    <div class="modal-overlay" id="sql-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>ConfiguraciÃ³n SQL</h3>
                <button class="close-modal" onclick="closeModal('sql-modal')">&times;</button>
            </div>
            <p>Ejecuta esto en el SQL Editor de Supabase antes de crear viajes.</p>
            <div style="background:#1f2937; color:#e5e7eb; padding:1rem; border-radius:8px; font-family:monospace; font-size:0.85rem; overflow-x:auto; position:relative;">
                <button onclick="copySQL()" style="position:absolute; top:5px; right:5px; background:rgba(255,255,255,0.2); border:none; color:white; padding:2px 8px; cursor:pointer;">Copiar</button>
<pre>
create table trips (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  destination text,
  trip_data jsonb not null default '{}'::jsonb
);

alter table trips enable row level security;
create policy "Public Access" on trips for select using (true);
create policy "Public Insert" on trips for insert with check (true);
create policy "Public Update" on trips for update using (true);
create policy "Public Delete" on trips for delete using (true);
</pre>
            </div>
            <button class="btn-primary" onclick="closeModal('sql-modal')">Entendido</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-area"></div>

    <script>
        // --- VARIABLES SUPABASE ---
        let supabaseClient = null;
        let currentTripId = null; // Guardamos el ID del viaje que estamos editando
        let appData = {
            destination: "", startDate: "", endDate: "", currencySymbol: "$", exchangeRate: 1, crcRate: 540, days: []
        };
        let activeDayIndex = 0;

        // --- INICIALIZACIÃ“N ---
        document.addEventListener('DOMContentLoaded', () => {
            // Buscar credenciales guardadas
            const url = localStorage.getItem('supa_url');
            const key = localStorage.getItem('supa_key');

            if(url && key) {
                document.getElementById('supa-url').value = url;
                document.getElementById('supa-key').value = key;
                connectSupabase();
            } else {
                document.getElementById('connection-panel').style.display = 'block';
            }
        });

        // --- CONEXIÃ“N SUPABASE ---
        async function connectSupabase() {
            const url = document.getElementById('supa-url').value.trim();
            const key = document.getElementById('supa-key').value.trim();

            if(!url || !key) { showToast('Faltan credenciales', 'error'); return; }

            try {
                const { createClient } = window.supabase;
                supabaseClient = createClient(url, key);
                
                // Test connection simple
                const { error } = await supabaseClient.from('trips').select('id').limit(1);
                
                if(error) throw error;

                // Ã‰xito
                localStorage.setItem('supa_url', url);
                localStorage.setItem('supa_key', key);
                
                document.getElementById('connection-panel').style.display = 'none';
                document.getElementById('status-text').textContent = 'Conectado';
                document.getElementById('status-dot').classList.add('connected');
                
                loadDashboard();

            } catch (e) {
                showToast('Error al conectar: ' + e.message, 'error');
            }
        }

        function logoutSupabase() {
            localStorage.removeItem('supa_url');
            localStorage.removeItem('supa_key');
            location.reload();
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            document.getElementById('dashboard-panel').style.display = 'block';
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'none';

            const listContainer = document.getElementById('trips-list-container');
            listContainer.innerHTML = '<p style="text-align:center; width:100%;">Cargando viajes...</p>';

            const { data, error } = await supabaseClient.from('trips').select('*').order('created_at', { ascending: false });

            if(error) {
                listContainer.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
                return;
            }

            if(!data || data.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:var(--gray);">No tienes viajes guardados aÃºn.</p>';
                return;
            }

            listContainer.innerHTML = '';
            data.forEach(trip => {
                // Acceso seguro al JSONB
                const info = trip.trip_data || {};
                const dest = info.destination || 'Viaje sin tÃ­tulo';
                const dates = info.startDate ? new Date(info.startDate).toLocaleDateString() : '?';
                
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.onclick = (e) => {
                    if(!e.target.closest('.btn-icon-small')) loadTrip(trip.id, trip.trip_data);
                };

                card.innerHTML = `
                    <div class="trip-card-actions">
                        <button class="btn-icon-small" onclick="deleteTrip(${trip.id}, event)" title="Borrar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h3>${dest}</h3>
                    <p><i class="far fa-calendar"></i> Inicio: ${dates}</p>
                    <p style="font-size:0.75rem; color:#aaa;">ID: ${trip.id}</p>
                `;
                listContainer.appendChild(card);
            });
        }

        function showNewTripForm() {
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('setup-trip-form').style.display = 'block';
        }

        function backToDashboard() {
            if(confirm("Â¿Los cambios no guardados se perderÃ¡n. Volver al inicio?")) {
                loadDashboard();
            }
        }

        async function deleteTrip(id, e) {
            e.stopPropagation();
            if(!confirm("Â¿EstÃ¡s seguro de eliminar este viaje de la base de datos?")) return;

            const { error } = await supabaseClient.from('trips').delete().eq('id', id);
            if(error) showToast('Error al borrar', 'error');
            else {
                showToast('Viaje eliminado', 'success');
                loadDashboard();
            }
        }

        // --- CREACIÃ“N DE VIAJE (INSERT) ---
        async function handleCreateTrip(e) {
            e.preventDefault();
            const dest = document.getElementById('destination').value;
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const currSymbol = document.getElementById('currency-symbol').value;
            const exRate = parseFloat(document.getElementById('exchange-rate').value);
            const crcRateVal = parseFloat(document.getElementById('crc-rate').value);

            // Preparar dÃ­as
            const daysList = [];
            let current = new Date(start);
            const endDateObj = new Date(end);
            while (current <= endDateObj) {
                const dateString = current.toISOString().split('T')[0];
                daysList.push({ date: dateString, activities: [], expenses: { food: 0, transport: 0, tickets: 0 } });
                current.setDate(current.getDate() + 1);
            }

            // Objeto de datos
            const newTripData = {
                destination: dest, startDate: start, endDate: end,
                currencySymbol: currSymbol, exchangeRate: exRate, crcRate: crcRateVal || 540,
                days: daysList
            };

            // Guardar en Supabase
            const { data, error } = await supabaseClient.from('trips').insert({
                destination: dest,
                trip_data: newTripData
            }).select();

            if(error) {
                showToast('Error guardando en base de datos: ' + error.message, 'error');
            } else {
                currentTripId = data[0].id;
                appData = newTripData;
                activeDayIndex = 0;
                showPlanner();
                showToast('Viaje creado exitosamente', 'success');
            }
        }

        // --- CARGAR VIAJE EXISTENTE ---
        function loadTrip(id, tripData) {
            currentTripId = id;
            appData = tripData;
            // Validaciones de seguridad por si el formato cambia en el futuro
            if(!appData.days) appData.days = [];
            
            activeDayIndex = 0;
            showPlanner();
        }

        // --- SYNC / UPDATE DB ---
        async function syncTripToDB() {
            if(!currentTripId || !supabaseClient) return;

            // Actualizamos solo la columna 'trip_data' del registro actual
            // Nota: En un entorno real podrÃ­amos optimizar para no enviar todo cada vez, pero para esto estÃ¡ perfecto.
            const { error } = await supabaseClient.from('trips')
                .update({ trip_data: appData })
                .eq('id', currentTripId);

            if(error) {
                console.error("Error guardando:", error);
                showToast('Error de sincronizaciÃ³n', 'error');
            }
        }

        // --- UI LOGIC (Copiada y Adaptada) ---
        function showPlanner() {
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'block';
            document.getElementById('summary-bar').style.display = 'flex';

            document.getElementById('display-destination').textContent = appData.destination;
            document.getElementById('display-currency').textContent = appData.currencySymbol || 'Local';
            document.getElementById('display-rate').textContent = appData.exchangeRate;
            document.getElementById('display-crc-rate').textContent = appData.crcRate || '---';

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = `${new Date(appData.startDate).toLocaleDateString('es-ES', options)} - ${new Date(appData.endDate).toLocaleDateString('es-ES', options)}`;
            document.getElementById('display-dates').textContent = dateStr;

            renderTabs();
            renderActiveDay();
            updateTotalCost();
        }

        // Reemplazamos saveToStorage original por syncTripToDB
        async function saveToStorage() {
            await syncTripToDB();
            updateTotalCost();
            renderActiveDay();
        }

        function fillCurrencyFromPreset() {
            const select = document.getElementById('preset-currency');
            const value = select.value;
            if(value) {
                const [symbol, rate] = value.split('|');
                document.getElementById('currency-symbol').value = symbol;
                document.getElementById('exchange-rate').value = rate;
            }
        }

        function openRateModal() {
            document.getElementById('rate-modal-symbol').textContent = appData.currencySymbol || 'local';
            document.getElementById('new-exchange-rate').value = appData.exchangeRate;
            document.getElementById('new-crc-rate').value = appData.crcRate || 540;
            document.getElementById('rate-modal').classList.add('active');
        }

        async function saveNewRates() {
            const newRate = parseFloat(document.getElementById('new-exchange-rate').value);
            const newCrcRate = parseFloat(document.getElementById('new-crc-rate').value);
            if(newRate > 0) {
                appData.exchangeRate = newRate;
                appData.crcRate = newCrcRate > 0 ? newCrcRate : 0;
                await saveToStorage();
                document.getElementById('display-rate').textContent = newRate;
                document.getElementById('display-crc-rate').textContent = newCrcRate;
                closeModal('rate-modal');
                showToast('Tipos de cambio actualizados', 'success');
            } else {
                alert("El tipo de cambio debe ser mayor a 0");
            }
        }

        // --- RENDERIZADO ---
        function renderTabs() {
            const nav = document.getElementById('tabs-nav');
            nav.innerHTML = '';
            appData.days.forEach((day, index) => {
                const dateObj = new Date(day.date);
                const shortDate = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === activeDayIndex ? 'active' : ''}`;
                btn.onclick = () => { activeDayIndex = index; renderTabs(); renderActiveDay(); };
                btn.innerHTML = `<span>DÃ­a ${index + 1}</span><span class="tab-date">${shortDate}</span>`;
                nav.appendChild(btn);
            });
            const totalBtn = document.createElement('button');
            totalBtn.className = `tab-btn summary-tab ${activeDayIndex === appData.days.length ? 'active' : ''}`;
            totalBtn.onclick = () => { activeDayIndex = appData.days.length; renderTabs(); renderActiveDay(); };
            totalBtn.innerHTML = `<span><i class="fas fa-chart-pie"></i></span><span class="tab-date">Resumen</span>`;
            nav.appendChild(totalBtn);
        }

        function convertToUSD(amount, currencyCode) {
            const val = parseFloat(amount) || 0;
            const code = currencyCode || 'local';
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            if (code === 'usd') return val;
            if (code === 'crc') return val / crcRate;
            return val / rate;
        }

        function formatMoney(amount) {
            return parseFloat(amount).toFixed(2);
        }

        function renderActiveDay() {
            if (activeDayIndex === appData.days.length) { renderSummarySheet(); return; }

            const container = document.getElementById('tab-content');
            const day = appData.days[activeDayIndex];
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate;
            const crcRate = appData.crcRate || 0;

            // CÃ¡lculos
            let dayTotalUSD = 0;
            day.activities.forEach(act => { dayTotalUSD += convertToUSD(act.cost, act.currency); });
            dayTotalUSD += (parseFloat(day.expenses.food || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.transport || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.tickets || 0) / rate);

            const dayTotalLocal = dayTotalUSD * rate;
            const dayTotalCRC = dayTotalUSD * crcRate;
            const tripTotals = calculateTripTotals();

            const dateObj = new Date(day.date);
            const fullDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            const capitalDate = fullDate.charAt(0).toUpperCase() + fullDate.slice(1);

            container.innerHTML = `
                <div class="day-total-header">
                    <div class="day-title-section"><i class="far fa-calendar-alt"></i> ${capitalDate}</div>
                    <div class="totals-grid">
                        <div class="total-row"><span class="currency-label">USD</span><div class="currency-values"><span class="val-day">$${dayTotalUSD.toFixed(2)}</span> | <span class="val-trip">Viaje: $${tripTotals.usd.toFixed(2)}</span></div></div>
                        ${crcRate > 0 ? `<div class="total-row"><span class="currency-label">Col</span><div class="currency-values"><span class="val-day">â‚¡${dayTotalCRC.toLocaleString()}</span> | <span class="val-trip">Viaje: â‚¡${tripTotals.crc.toLocaleString()}</span></div></div>` : ''}
                        <div class="total-row"><span class="currency-label">${symbol}</span><div class="currency-values"><span class="val-day">${formatMoney(dayTotalLocal)}</span> | <span class="val-trip">Viaje: ${formatMoney(tripTotals.local)}</span></div></div>
                    </div>
                </div>
                <ul class="activity-list">${renderActivitiesListHTML(day, activeDayIndex, symbol, rate, crcRate)}</ul>
                <button class="btn-add-activity" onclick="openModal('add', ${activeDayIndex})"><i class="fas fa-plus"></i> AÃ±adir Actividad</button>
                <div class="daily-expenses">
                    <div class="expense-title">Otros Gastos Diarios (${symbol})</div>
                    <div class="expense-grid">
                        <div class="expense-input"><label><i class="fas fa-utensils"></i> Comida</label><input type="number" min="0" step="0.5" value="${day.expenses.food}" onchange="updateExpense(${activeDayIndex}, 'food', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-bus"></i> Transporte</label><input type="number" min="0" step="0.5" value="${day.expenses.transport}" onchange="updateExpense(${activeDayIndex}, 'transport', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-ticket-alt"></i> Entradas</label><input type="number" min="0" step="0.5" value="${day.expenses.tickets}" onchange="updateExpense(${activeDayIndex}, 'tickets', this.value)"></div>
                    </div>
                </div>
            `;
        }

        function renderActivitiesListHTML(day, dayIndex, symbol, rate, crcRate) {
            if (day.activities.length === 0) return `<li style="text-align:center; color:var(--gray); padding:2rem; border:1px dashed #ccc; border-radius:8px;">Sin actividades planeadas.</li>`;
            return day.activities.map((act, actIndex) => {
                let iconClass = 'act-icon-general';
                if(['fa-utensils'].includes(act.icon)) iconClass = 'act-icon-food';
                if(['fa-bus','fa-taxi','fa-subway'].includes(act.icon)) iconClass = 'act-icon-transport';
                if(['fa-landmark','fa-university'].includes(act.icon)) iconClass = 'act-icon-culture';
                if(['fa-plane'].includes(act.icon)) iconClass = 'act-icon-travel';
                if(['fa-bed'].includes(act.icon)) iconClass = 'act-icon-lodging';
                if(['fa-tree'].includes(act.icon)) iconClass = 'act-icon-nature';
                if(['fa-shopping-bag'].includes(act.icon)) iconClass = 'act-icon-shopping';
                if(['fa-glass-cheers'].includes(act.icon)) iconClass = 'act-icon-party';

                const iconToDisplay = act.icon || 'fa-star';
                const costVal = parseFloat(act.cost);
                const currCode = act.currency || 'local'; 
                let originalSymbol = currCode === 'usd' ? '$' : (currCode === 'crc' ? 'â‚¡' : symbol);
                const costUSD = convertToUSD(costVal, currCode);
                const costCRC = costUSD * crcRate;
                const costLocal = costUSD * rate; 

                return `
                <li class="activity-item">
                    <div class="activity-top">
                        <div class="activity-time">${act.time}</div>
                        <div class="activity-details">
                            <div class="activity-name"><i class="fas ${iconToDisplay} ${iconClass}"></i> ${act.name}</div>
                            <div class="activity-meta"><i class="fas fa-map-marker-alt"></i> ${act.location}</div>
                            ${act.howToGet ? `<div class="activity-meta"><i class="fas fa-directions"></i> <span>${act.howToGet}</span></div>` : ''}
                            ${act.link ? `<div class="activity-meta"><i class="fas fa-globe"></i> <a href="${act.link}" target="_blank" class="activity-link">Visitar sitio web</a></div>` : ''}
                            <div style="margin-top: 8px;">
                                <div class="activity-meta" style="color: var(--dark); font-weight: bold; margin-bottom:2px;">
                                    <i class="fas fa-coins"></i> ${originalSymbol}${costVal.toFixed(2)} <span style="font-size:0.8em; font-weight:normal; color:var(--gray); text-transform:uppercase;">(${currCode})</span>
                                </div>
                                <div style="font-size:0.85em; color:var(--gray); padding-left: 20px;">
                                    <div>â†’ $${costUSD.toFixed(2)} USD</div>
                                    ${crcRate > 0 ? `<div>â†’ â‚¡${costCRC.toLocaleString()} Colones</div>` : ''}
                                    ${currCode !== 'local' ? `<div>â†’ ${formatMoney(costLocal)} ${symbol} (Equivalente)</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn-sm btn-edit" onclick="openModal('edit', ${dayIndex}, ${actIndex})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn-sm btn-delete" onclick="deleteActivity(${dayIndex}, ${actIndex})"><i class="fas fa-trash"></i> Borrar</button>
                    </div>
                </li>`;
            }).join('');
        }

        function updateExpense(dayIndex, type, value) {
            appData.days[dayIndex].expenses[type] = parseFloat(value) || 0;
            saveToStorage();
        }

        // --- CRUD ACTIVIDADES ---
        function openModal(mode, dayIndex, actIndex = null) {
            document.getElementById('activity-modal').classList.add('active');
            document.getElementById('modal-day-index').value = dayIndex;
            document.getElementById('modal-activity-index').value = actIndex !== null ? actIndex : '';
            const form = document.getElementById('activity-form');
            if (mode === 'edit' && actIndex !== null) {
                document.getElementById('modal-title').textContent = 'Editar Actividad';
                const act = appData.days[dayIndex].activities[actIndex];
                document.getElementById('act-icon').value = act.icon || 'fa-star';
                document.getElementById('act-time').value = act.time;
                document.getElementById('act-name').value = act.name;
                document.getElementById('act-location').value = act.location;
                document.getElementById('act-transport').value = act.howToGet;
                document.getElementById('act-link').value = act.link;
                document.getElementById('act-cost').value = act.cost;
                document.getElementById('act-currency').value = act.currency || 'local';
            } else {
                document.getElementById('modal-title').textContent = 'AÃ±adir Actividad';
                form.reset();
                document.getElementById('act-icon').value = 'fa-star';
                document.getElementById('act-cost').value = 0;
                document.getElementById('act-currency').value = 'local';
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        async function saveActivity(e) {
            e.preventDefault();
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const actIndexStr = document.getElementById('modal-activity-index').value;
            
            const activityData = {
                icon: document.getElementById('act-icon').value,
                time: document.getElementById('act-time').value,
                name: document.getElementById('act-name').value,
                location: document.getElementById('act-location').value,
                howToGet: document.getElementById('act-transport').value,
                link: document.getElementById('act-link').value,
                cost: parseFloat(document.getElementById('act-cost').value),
                currency: document.getElementById('act-currency').value 
            };

            if (actIndexStr !== '') {
                appData.days[dayIndex].activities[parseInt(actIndexStr)] = activityData;
            } else {
                appData.days[dayIndex].activities.push(activityData);
                appData.days[dayIndex].activities.sort((a, b) => a.time.localeCompare(b.time));
            }
            await saveToStorage();
            closeModal('activity-modal');
        }

        async function deleteActivity(dayIndex, actIndex) {
            if(confirm("Â¿Eliminar esta actividad?")) {
                appData.days[dayIndex].activities.splice(actIndex, 1);
                await saveToStorage();
            }
        }

        // --- RESUMEN ---
        function renderSummarySheet() {
            const container = document.getElementById('tab-content');
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate;
            const crcRate = appData.crcRate || 0;
            const totals = calculateTripTotals();
            const breakdown = calculateCategoryBreakdown();

            const dailyTotals = appData.days.map((day, idx) => {
                let totalUSD = 0;
                day.activities.forEach(a => totalUSD += convertToUSD(a.cost, a.currency));
                totalUSD += (parseFloat(day.expenses.food || 0) / rate);
                totalUSD += (parseFloat(day.expenses.transport || 0) / rate);
                totalUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                return { idx: idx + 1, date: day.date, total: totalUSD };
            }).sort((a,b) => b.total - a.total);

            container.innerHTML = `
                <div class="summary-card">
                    <h2 class="summary-title">Resumen Financiero</h2>
                    <div class="big-totals">
                        <div class="big-total-item"><span class="bt-label">DÃ³lares (USD)</span><span class="bt-value usd">$${totals.usd.toFixed(2)}</span></div>
                        ${crcRate > 0 ? `<div class="big-total-item"><span class="bt-label">Colones (CRC)</span><span class="bt-value crc">â‚¡${totals.crc.toLocaleString()}</span></div>` : ''}
                        <div class="big-total-item"><span class="bt-label">${symbol} (Local)</span><span class="bt-value local">${formatMoney(totals.local)}</span></div>
                    </div>
                    <div class="summary-grid">
                        <div class="breakdown-section">
                            <h3>Por CategorÃ­a</h3>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-utensils" style="color:#e17055;"></i> Comida</span><span class="cat-val">$${breakdown.foodUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-bus" style="color:#0984e3;"></i> Transporte</span><span class="cat-val">$${breakdown.transportUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-ticket-alt" style="color:#fdcb6e;"></i> Entradas</span><span class="cat-val">$${breakdown.ticketsUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-list" style="color:#b2bec3;"></i> Actividades</span><span class="cat-val">$${breakdown.activitiesUSD.toFixed(2)}</span></div>
                        </div>
                        <div class="breakdown-section">
                            <h3>DÃ­as mÃ¡s costosos</h3>
                            ${dailyTotals.map(d => `<div class="breakdown-row"><span class="cat-name">DÃ­a ${d.idx}</span><span class="cat-val">$${d.total.toFixed(2)}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function calculateCategoryBreakdown() {
            let foodUSD = 0, transportUSD = 0, ticketsUSD = 0, activitiesUSD = 0;
            const rate = appData.exchangeRate || 1;
            appData.days.forEach(day => {
                foodUSD += (parseFloat(day.expenses.food || 0) / rate);
                transportUSD += (parseFloat(day.expenses.transport || 0) / rate);
                ticketsUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                day.activities.forEach(act => { activitiesUSD += convertToUSD(act.cost, act.currency); });
            });
            return { foodUSD, transportUSD, ticketsUSD, activitiesUSD };
        }

        function calculateTripTotals() {
            let grandTotalUSD = 0;
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            appData.days.forEach(day => {
                day.activities.forEach(act => { grandTotalUSD += convertToUSD(act.cost, act.currency); });
                grandTotalUSD += (parseFloat(day.expenses.food || 0) / rate);
                grandTotalUSD += (parseFloat(day.expenses.transport || 0) / rate);
                grandTotalUSD += (parseFloat(day.expenses.tickets || 0) / rate);
            });
            return { usd: grandTotalUSD, crc: grandTotalUSD * crcRate, local: grandTotalUSD * rate };
        }

        function updateTotalCost() {
            const tripTotals = calculateTripTotals();
            document.getElementById('grand-total').textContent = '$' + tripTotals.usd.toFixed(2) + ' USD';
            const crcRate = appData.crcRate || 0;
            if(crcRate > 0) {
                document.getElementById('grand-total-crc').textContent = 'â‚¡' + tripTotals.crc.toLocaleString() + ' Colones';
                document.getElementById('grand-total-crc').style.display = 'block';
            } else { document.getElementById('grand-total-crc').style.display = 'none'; }
        }

        // --- UTILIDADES ---
        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerText = msg;
            document.getElementById('toast-area').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function copySQL() {
            const text = document.querySelector('#sql-modal pre').innerText;
            navigator.clipboard.writeText(text);
            showToast('SQL Copiado');
        }

        // Abrir modal SQL si no hay tabla de trips (detectado por error al cargar dashboard)
        // Esto es opcional, lo dejo manual por ahora para no bloquear
    </script>
</body>
</html>
```

