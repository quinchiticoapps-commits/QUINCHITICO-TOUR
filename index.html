```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quinchitico Tour - Gestor Pro</title>
    
    <!-- Iconos y Estilos -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%2300cec9' d='M498.4 228.5L285.2 25.3c-4.3-4.1-10.2-6.1-16.1-5.5l-224 22.4c-6.6.7-12.4 4.7-15.4 10.7L3.4 252.1c-3.8 7.5-2.7 16.6 2.7 23l193 228.7c4.4 5.2 11.1 8.1 18 7.6l256-20c6.9-.5 13.1-4.5 16.3-10.7l22.4-44.8c2.8-5.6 2.4-12.2-1-17.4L498.4 228.5z'/></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quinchitico Tour">
    <meta name="theme-color" content="#00cec9">
    <meta name="application-name" content="Quinchitico Tour">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%2300cec9' rx='115'/><path fill='white' d='M498.4 228.5L285.2 25.3c-4.3-4.1-10.2-6.1-16.1-5.5l-224 22.4c-6.6.7-12.4 4.7-15.4 10.7L3.4 252.1c-3.8 7.5-2.7 16.6 2.7 23l193 228.7c4.4 5.2 11.1 8.1 18 7.6l256-20c6.9-.5 13.1-4.5 16.3-10.7l22.4-44.8c2.8-5.6 2.4-12.2-1-17.4L498.4 228.5z'/></svg>">
    <link rel="icon" type="image/svg+xml" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%2300cec9' rx='115'/><path fill='white' d='M498.4 228.5L285.2 25.3c-4.3-4.1-10.2-6.1-16.1-5.5l-224 22.4c-6.6.7-12.4 4.7-15.4 10.7L3.4 252.1c-3.8 7.5-2.7 16.6 2.7 23l193 228.7c4.4 5.2 11.1 8.1 18 7.6l256-20c6.9-.5 13.1-4.5 16.3-10.7l22.4-44.8c2.8-5.6 2.4-12.2-1-17.4L498.4 228.5z'/></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00cec9; --secondary: #0984e3; --accent: #fdcb6e;
            --danger: #ff7675; --dark: #2d3436; --light: #f5f6fa;
            --white: #ffffff; --gray: #b2bec3; --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--light); color: var(--dark); padding-bottom: 100px; }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        header h1 { font-size: 2rem; margin-bottom: 0.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { font-size: 1rem; opacity: 0.9; }

        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .card { background: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 1rem; text-align: center; }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-row { display: flex; gap: 1rem; }
        .form-row .form-group { flex: 1; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 0.7rem; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 0.95rem; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-primary {
            background-color: var(--secondary); color: white; border: none; padding: 0.8rem 2rem;
            font-size: 1rem; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold;
            transition: transform 0.2s, background 0.3s; margin-top: 1rem;
        }
        .btn-primary:hover { background-color: #0769b5; transform: translateY(-2px); }
        .btn-primary.tight { width: auto; padding: 0.5rem 1rem; margin-top: 0; }

        .btn-secondary {
            background-color: var(--gray); color: white; border: none; padding: 0.6rem 1.5rem;
            font-size: 0.9rem; border-radius: 8px; cursor: pointer; margin-top: 1rem; margin-right: 10px;
        }
        .btn-secondary:hover { background-color: #636e72; }

        /* Lista de Viajes */
        .trip-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .trip-card {
            background: #f8f9fa; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem;
            text-align: left; cursor: pointer; transition: 0.2s; position: relative;
        }
        .trip-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .trip-card h3 { color: var(--dark); margin-bottom: 0.5rem; }
        .trip-card p { color: var(--gray); font-size: 0.85rem; margin-bottom: 0.2rem; }
        .trip-card-actions { position: absolute; top: 10px; right: 10px; }
        .btn-icon-small { background: none; border: none; color: var(--gray); cursor: pointer; padding: 5px; }
        .btn-icon-small:hover { color: var(--danger); }

        /* --- PANEL PLANIFICADOR --- */
        #planner-panel { display: none; animation: fadeIn 0.5s ease-in; }
        .trip-header-info {
            background: var(--white); padding: 1rem; border-radius: var(--radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1rem; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .trip-title { font-size: 1.3rem; color: var(--secondary); font-weight: 800; }
        .currency-info { text-align: right; font-size: 0.85rem; }
        .btn-back { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 20px; cursor: pointer; margin-right: 10px; }

        /* --- TABS & ACTIVITIES --- */
        .tabs-wrapper { background: var(--white); border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; margin-top: 1rem; }
        .tabs-nav { display: flex; background: #f1f2f6; overflow-x: auto; border-bottom: 2px solid #dfe6e9; position: sticky; top: 0; z-index: 10; }
        .tabs-nav::-webkit-scrollbar { height: 4px; }
        .tab-btn { padding: 1rem 1.2rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--gray); white-space: nowrap; transition: 0.3s; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; min-width: 90px; }
        .tab-btn:hover { background: #e0e0e0; color: var(--dark); }
        .tab-btn.active { color: var(--primary); background: white; border-bottom: 3px solid var(--primary); }
        .tab-date { font-size: 0.75rem; font-weight: normal; margin-top: 2px; }

        /* Activity List */
        .day-total-header { background: #e0f7fa; border: 1px solid #b2bec3; border-radius: 8px; margin-bottom: 1.5rem; text-align: left; overflow: hidden; }
        .day-title-section { background: #00cec9; color: white; padding: 0.8rem 1rem; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .totals-grid { padding: 1rem; display: flex; flex-direction: column; gap: 8px; background: white; }
        .total-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .currency-label { font-weight: bold; color: var(--dark); min-width: 50px; }
        .currency-values { text-align: right; font-size: 0.95rem; }
        .val-day { font-weight: bold; color: var(--secondary); margin-right: 10px; }
        .val-trip { color: var(--gray); font-size: 0.85rem; }

        .activity-list { list-style: none; margin-bottom:1.5rem; }
        .activity-item { display: flex; flex-direction: column; padding: 1rem; border-bottom: 1px solid #f1f2f6; position: relative; transition: background 0.2s; border-radius: 8px; }
        .activity-item:hover { background-color: #fdfdfd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .activity-top { display: flex; align-items: flex-start; gap: 1rem; }
        .activity-time { font-weight: bold; color: var(--secondary); min-width: 60px; font-size: 0.95rem; padding-top: 2px; }
        .activity-details { flex-grow: 1; }
        .activity-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 8px; }
        .activity-meta { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .activity-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 4px; }
        .btn-edit { background: #e0f7fa; color: var(--secondary); }
        .btn-delete { background: #ffebee; color: var(--danger); }

        /* --- ESTILOS GASTOS DIARIOS --- */
        .daily-expenses { background-color: #fdfdfd; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .expense-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom:1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; font-weight: 700; }
        .expense-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .expense-input label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.2rem; display: flex; align-items: center; gap: 5px; }

        /* Lista Detallada de Gastos Diarios */
        .daily-expense-list { margin-bottom: 1.5rem; }
        .daily-expense-list-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .daily-expense-list-item:last-child { border-bottom: none; }
        .daily-expense-name { flex-grow: 1; }
        .daily-expense-cost { font-weight: 600; color: var(--secondary); margin-right: 15px; }
        .daily-expense-actions { display: flex; gap: 5px; }
        .daily-expense-edit { color: #0984e3; cursor: pointer; transition: 0.2s; }
        .daily-expense-edit:hover { color: #00cec9; }
        .daily-expense-delete { color: #ff7675; cursor: pointer; transition: 0.2s; }
        .daily-expense-delete:hover { color: #d63031; }

        /* --- COLORES DE ICONOS --- */
        .act-icon-food { color: #e17055; }
        .act-icon-transport { color: #0984e3; }
        .act-icon-lodging { color: #6c5ce7; }
        .act-icon-nature { color: #00b894; }
        .act-icon-culture { color: #fdcb6e; }
        .act-icon-party { color: #e84393; }

        /* SECCIONES NUEVAS (GASTOS) */
        .shared-expenses-box { border: 1px solid #fdcb6e; background: #fffbf0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .personal-expenses-box { border: 1px solid #00cec9; background: #e0fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .expense-row-list { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.9rem; cursor: pointer; }
        .expense-row-list:hover { background: rgba(0,0,0,0.02); }

        /* Summary Styles */
        .summary-card { background: var(--white); border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .summary-title { font-size: 1.5rem; color: var(--secondary); margin-bottom: 1.5rem; font-weight: bold; }
        .big-totals { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-bottom: 2rem; }
        .big-total-item { flex: 1; min-width: 150px; padding: 1.5rem; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
        .bt-label { display: block; font-size: 0.9rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.5rem; }
        .bt-value { display: block; font-size: 1.8rem; font-weight: 800; color: var(--dark); }

        /* --- FLOATING BAR --- */
        .floating-summary { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--dark); color: white; padding: 0.8rem 2rem; display: flex; justify-content: center; align-items: center; gap: 0.3rem; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); z-index: 100; }
        .floating-summary .total-amount { font-size: 1.2rem; font-weight: bold; color: var(--accent); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom:1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }

        /* --- ESTILO GRID DE ICONOS --- */
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; margin-top: 5px; }
        .icon-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; border: 2px solid #dfe6e9; border-radius: 8px; cursor: pointer;
            background: white; transition: all 0.2s;
        }
        .icon-btn i { font-size: 1.5rem; margin-bottom: 5px; color: var(--gray); }
        .icon-btn span { font-size: 0.7rem; color: var(--gray); text-align: center; line-height: 1.2; }
        
        /* Estado seleccionado */
        .icon-btn.selected { border-color: var(--primary); background-color: #e0fffa; }
        .icon-btn.selected i, .icon-btn.selected span { color: var(--secondary); font-weight: bold; }

        /* Colores hover espec√≠ficos para dar feedback visual */
        .icon-btn:hover { border-color: var(--secondary); }
        .icon-btn[data-cat="food"]:hover i { color: #e17055; }
        .icon-btn[data-cat="transport"]:hover i { color: #0984e3; }
        .icon-btn[data-cat="lodging"]:hover i { color: #6c5ce7; }
        .icon-btn[data-cat="nature"]:hover i { color: #00b894; }
        .icon-btn[data-cat="culture"]:hover i { color: #fdcb6e; }
        .icon-btn[data-cat="party"]:hover i { color: #e84393; }

        /* Auth Specific */
        .auth-container { max-width: 400px; margin: 50px auto; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #aaa; }
        .status-dot.connected { background: #2ecc71; }
        .admin-only-btn { display: none; }
        .admin-mode .admin-only-btn { display: inline-block; }
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .user-list-actions button { margin-left: 5px; font-size: 0.8rem; padding: 4px 8px; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 2000; animation: slideIn 0.3s; max-width: 300px; word-wrap: break-word;}
        .toast.success { border-left: 4px solid #2ecc71; }
        .toast.error { border-left: 4px solid #e74c3c; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div id="connection-status-badge" style="position:absolute; top:1rem; right:1rem; background:rgba(0,0,0,0.3); padding:4px 10px; border-radius:15px; font-size:0.8rem; display:flex; align-items:center; gap:5px;">
            <div class="status-dot" id="status-dot"></div> <span id="status-text">Desconectado</span>
        </div>
        <h1><i class="fas fa-plane-departure"></i> Quinchitico Tour</h1>
        <p>Planifica y gestiona tus viajes</p>
    </header>

    <!-- 1. AUTH / LOGIN PANEL -->
    <div id="auth-panel" class="container auth-container" style="display:none;">
        <div class="card">
            <h2 style="margin-bottom:1rem;">Iniciar Sesi√≥n</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><input type="email" id="login-email" placeholder="Correo" required></div>
                <div class="form-group"><input type="password" id="login-pass" placeholder="Contrase√±a" required></div>
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
            <button class="btn-secondary" style="width:100%; margin-top:10px;" onclick="openModal('register-modal')">Crear Cuenta</button>
            <button class="btn-secondary" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="resetConnection()">Cambiar BD</button>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div class="container" id="dashboard-panel" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2>Mis Viajes</h2>
            <button id="btn-manage-users" class="btn-primary admin-only-btn" onclick="openUserModal()" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem;">
                <i class="fas fa-users-cog"></i> Usuarios
            </button>
        </div>
        
        <button class="btn-primary" onclick="showNewTripForm()">
            <i class="fas fa-plus"></i> Crear Nuevo Itinerario
        </button>

        <div id="trips-list-container" class="trip-list">
            <!-- JS render -->
        </div>
    </div>

    <!-- 3. FORMULARIO NUEVO VIAJE -->
    <div class="container" id="setup-trip-form" style="display:none;">
        <div class="card" style="text-align:left;">
            <h2 style="margin-bottom: 1rem;">Nuevo Viaje</h2>
            <button class="btn-secondary" onclick="backToDashboard()" style="width:100%; margin-bottom:1.5rem; background:#dfe6e9; color:#636e72;">
                <i class="fas fa-arrow-left"></i> Atr√°s
            </button>
            
            <form id="trip-form" onsubmit="handleCreateTrip(event)">
                <div class="form-group">
                    <label for="destination">Destino del Viaje</label>
                    <input type="text" id="destination" placeholder="Ej: Par√≠s, Tokyo" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Inicio</label>
                        <input type="date" id="start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">Fin</label>
                        <input type="date" id="end-date" required>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 1rem 0;">
                
                <div class="form-group">
                    <label>Seleccionar Moneda Principal</label>
                    <select id="preset-currency" onchange="fillCurrencyFromPreset()">
                        <option value="">-- O haz clic para seleccionar --</option>
                        <option value="USD|1">üá∫üá∏ USD - D√≥lar Americano</option>
                        <option value="MXN|18">üá≤üáΩ MXN - Peso Mexicano</option>
                        <option value="EUR|0.95">üá™üá∫ EUR - Euro</option>
                        <option value="CRC|540">üá®üá∑ CRC - Col√≥n Costarricense</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="currency-symbol">Moneda (S√≠mbolo)</label>
                        <input type="text" id="currency-symbol" placeholder="$" value="$" required>
                    </div>
                    <div class="form-group">
                        <label for="exchange-rate">Tipo de Cambio (1 USD)</label>
                        <input type="number" id="exchange-rate" placeholder="¬øCu√°nto de tu moneda es 1 USD?" step="0.01" value="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="crc-rate">Tipo de cambio a Colones (1 USD = ? Colones)</label>
                    <input type="number" id="crc-rate" placeholder="Ej: 540" step="1" value="540">
                    <p style="font-size: 0.75rem; color: var(--gray); margin-top: 2px;">Necesario para calcular los totales en Colones.</p>
                </div>

                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="backToDashboard()" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">
                        <i class="fas fa-save"></i> Crear y Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. PANEL PLANIFICADOR -->
    <div class="container" id="planner-panel">
        <div class="trip-header-info">
            <div>
                <button class="btn-back" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i> Atr√°s</button>
                <div class="trip-title" id="display-destination">Destino</div>
                <small id="display-dates" style="color:var(--gray)">Fechas</small>
            </div>
            <div class="currency-info">
                <div>
                    <strong id="display-currency">USD</strong>
                    <button class="btn-edit-rate" onclick="openRateModal()" title="Editar tipos de cambio" style="background:none; border:1px solid #ccc; border-radius:4px; padding:2px 6px; cursor:pointer;">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <div>1 USD = <strong id="display-rate">1</strong> <small>(Local)</small></div>
                <div>1 USD = <strong id="display-crc-rate">540</strong> <small>(Col)</small></div>
            </div>
        </div>

        <div class="tabs-wrapper">
            <nav class="tabs-nav" id="tabs-nav"></nav>
            <div class="tab-content" id="tab-content"></div>
        </div>

        <br><br>
    </div>

    <!-- Barra Flotante -->
    <div id="summary-bar" class="floating-summary" style="display: none;">
        <div style="font-size: 0.8rem; text-transform: uppercase;">Total del Viaje:</div>
        <div class="total-amount" id="grand-total">$0.00 USD</div>
        <div class="total-crc" id="grand-total-crc">‚Ç°0 Colones</div>
    </div>

    <!-- MODAL ACTIVIDAD -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">A√±adir Actividad</h3>
                <button class="close-modal" onclick="closeModal('activity-modal')">&times;</button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <input type="hidden" id="modal-day-index">
                <input type="hidden" id="modal-activity-index">
                
                <!-- GRID DE ICONOS -->
                <div class="form-group">
                    <label>Categor√≠a / Gasto</label>
                    <div class="icon-grid" id="activity-icon-grid"></div>
                    <input type="hidden" id="act-icon" value="fa-star">
                </div>

                <div class="form-group"><label>Hora</label><input type="time" id="act-time" required></div>
                <div class="form-group"><label>Nombre de la Actividad / Lugar</label><input type="text" id="act-name" placeholder="Ej: Visita al Museo" required></div>
                <div class="form-group"><label>Ubicaci√≥n</label><input type="text" id="act-location" placeholder="Direcci√≥n o Punto de referencia"></div>
                <div class="form-group"><label>C√≥mo llegar</label><input type="text" id="act-transport" placeholder="Ej: Metro Linea 3, Caminando 10min"></div>
                <div class="form-group"><label>Sitio Web (Opcional)</label><input type="url" id="act-link" placeholder="https://..."></div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="act-currency">Moneda</label>
                        <select id="act-currency">
                            <option value="local">Local</option>
                            <option value="usd">USD</option>
                            <option value="crc">Colones (CRC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-act-cost">Costo</label>
                        <input type="number" id="act-cost" min="0" step="0.01" value="0" required>
                    </div>
                </div>
                
                <!-- BOTONES CON CANCELAR -->
                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="closeModal('activity-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">Guardar Actividad</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL GASTO COMPARTIDO (ADMIN) -->
    <div class="modal-overlay" id="shared-expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Gasto Compartido (Admin)</h3>
                <button class="close-modal" onclick="closeModal('shared-expense-modal')">&times;</button>
            </div>
            <form onsubmit="saveSharedExpense(event)">
                <!-- GRID DE ICONOS PARA GASTOS COMPARTIDOS -->
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <div class="icon-grid" id="shared-icon-grid"></div>
                    <input type="hidden" id="shared-icon" value="fa-star">
                </div>

                <div class="form-group"><label>Descripci√≥n (Opcional)</label><input type="text" id="shared-desc" placeholder="Ej: Hotel Noche 1"></div>
                
                <!-- NUEVO: SELECTOR DE MONEDA Y COSTO -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="shared-currency">
                            <option value="local">Local</option>
                            <option value="usd">USD</option>
                            <option value="crc">Colones (CRC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Costo</label>
                        <input type="number" id="shared-cost" step="0.01" required>
                    </div>
                </div>

                <!-- BOTONES CON CANCELAR -->
                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="closeModal('shared-expense-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL GASTO PERSONAL (USER) -->
    <div class="modal-overlay" id="personal-expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Mi Gasto Personal</h3>
                <button class="close-modal" onclick="closeModal('personal-expense-modal')">&times;</button>
            </div>
            <form onsubmit="savePersonalExpense(event)">
                <!-- GRID DE ICONOS PARA GASTOS PERSONALES -->
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <div class="icon-grid" id="personal-icon-grid"></div>
                    <input type="hidden" id="personal-icon" value="fa-star">
                </div>

                <div class="form-group"><label>Descripci√≥n (Opcional)</label><input type="text" id="personal-desc" placeholder="Ej: Souvenir, Compras"></div>
                
                <!-- NUEVO: SELECTOR DE MONEDA Y COSTO -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Moneda</label>
                        <select id="personal-currency">
                            <option value="local">Local</option>
                            <option value="usd">USD</option>
                            <option value="crc">Colones (CRC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Costo</label>
                        <input type="number" id="personal-cost" step="0.01" required>
                    </div>
                </div>

                <!-- BOTONES CON CANCELAR -->
                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="closeModal('personal-expense-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL GESTION USUARIOS (ADMIN) -->
    <div class="modal-overlay" id="users-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Gestionar Usuarios</h3>
                <button class="close-modal" onclick="closeModal('users-modal')">&times;</button>
            </div>
            
            <form onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="edit-user-id">
                <div class="form-group"><label>Nombre</label><input type="text" id="user-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="user-pass" placeholder="Dejar vac√≠o para mantener actual" ></div>
                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="closeModal('users-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">Guardar Usuario</button>
                </div>
            </form>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Usuarios Existentes (Clic para editar)</h4>
            <ul id="users-list-ul" style="list-style:none; max-height:200px; overflow-y:auto; font-size:0.9rem; padding:0;"></ul>
        </div>
    </div>

    <!-- MODAL REGISTRO -->
    <div class="modal-overlay" id="register-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Crear Cuenta</h3>
                <button class="close-modal" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group"><label>Nombre</label><input type="text" id="reg-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="reg-email" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="reg-pass" required></div>
                <div class="form-row">
                    <button type="button" class="btn-secondary" onclick="closeModal('register-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex:2; margin-top:1rem; margin-left:5px;">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tipo de Cambio -->
    <div class="modal-overlay" id="rate-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Editar Tipos de Cambio</h3>
                <button class="close-modal" onclick="closeModal('rate-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Cambio USD a Local (1 USD = ? <span id="rate-modal-symbol"></span>)</label>
                <input type="number" id="new-exchange-rate" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Cambio USD a Colones (1 USD = ? Colones)</label>
                <input type="number" id="new-crc-rate" step="1" value="540">
            </div>
            <div class="form-row">
                <button type="button" class="btn-secondary" onclick="closeModal('rate-modal')" style="flex:1; margin-top:1rem; margin-right:5px;">Cancelar</button>
                <button class="btn-primary" onclick="saveNewRates()" style="flex:2; margin-top:1rem; margin-left:5px;">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-area"></div>

    <script>
        // --- CONFIGURACI√ìN DE CATEGOR√çAS PARA EL MEN√ö VISUAL ---
        const CATEGORIES = [
            { id: 'fa-plane', label: 'Vuelos', cat: 'transport' },
            { id: 'fa-utensils', label: 'Comida', cat: 'food' },
            { id: 'fa-landmark', label: 'Museos', cat: 'culture' },
            { id: 'fa-tree', label: 'Parques', cat: 'nature' },
            { id: 'fa-glass-cheers', label: 'Bares', cat: 'party' },
            { id: 'fa-bed', label: 'Hotel', cat: 'lodging' },
            { id: 'fa-bus', label: 'Bus/Taxi', cat: 'transport' },
            { id: 'fa-shopping-bag', label: 'Compras', cat: 'shopping' },
            { id: 'fa-ticket-alt', label: 'Entradas', cat: 'culture' },
            { id: 'fa-star', label: 'General', cat: 'general' }
        ];

        // --- CREDENCIALES AUTOMATICAS ---
        const AUTO_URL = "https://orinqfthcxrzcjgkmrmd.supabase.co";
        const AUTO_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yaW5xZnRoY3hyemNqZ2ttcm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDcyMzksImV4cCI6MjA4NTk4MzIzOX0.fzAlGiGozWJsFROtg0cbSymHWlUKkb-eQpNXpVRIOPY";

        // --- VARIABLES GLOBALES ---
        let supabaseClient = null;
        let currentUser = null;
        let currentTripId = null;
        
        let appData = {
            destination: "", startDate: "", endDate: "", currencySymbol: "$", exchangeRate: 1, crcRate: 540, days: []
        };
        let sharedExpenses = [];
        let personalExpenses = [];
        let activeDayIndex = 0;
        
        // Variable para controlar la edici√≥n de gastos diarios
        let editingDailyItemIndex = -1;

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', async () => {
            const url = localStorage.getItem('supa_url') || AUTO_URL;
            const key = localStorage.getItem('supa_key') || AUTO_KEY;

            try {
                const { createClient } = window.supabase;
                supabaseClient = createClient(url, key);
                
                // Verificar conexi√≥n
                const { error } = await supabaseClient.from('app_users').select('id').limit(1);
                if(error) throw error;

                document.getElementById('connection-status-badge').style.display = 'flex';
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').innerText = 'Conectado';

                localStorage.setItem('supa_url', url);
                localStorage.setItem('supa_key', key);

                const lastEmail = localStorage.getItem('last_user_email');
                if(lastEmail) document.getElementById('login-email').value = lastEmail;

                showAuthPanel();

            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n. Aseg√∫rate de haber ejecutado el SQL en Supabase.");
            }
        });

        // --- AUTH PANEL LOGIC ---
        function showAuthPanel() {
            document.getElementById('auth-panel').style.display = 'block';
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;

            const { data, error } = await supabaseClient
                .from('app_users')
                .select('*')
                .eq('email', email)
                .eq('password', pass)
                .single();

            if (error || !data) {
                showToast('Credenciales incorrectas', 'error');
            } else {
                currentUser = data;
                localStorage.setItem('last_user_email', email);
                initApp();
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            const { data: exist } = await supabaseClient.from('app_users').select('id').eq('email', email).single();
            if(exist) return showToast('Email ya registrado', 'error');

            const { count } = await supabaseClient.from('app_users').select('*', { count: 'exact', head: true });
            const role = count === 0 ? 'admin' : 'user';

            const { error } = await supabaseClient.from('app_users').insert({
                full_name: name, email: email, password: pass, role: role
            });

            if(error) showToast('Error registrando', 'error');
            else {
                showToast('Cuenta creada', 'success');
                closeModal('register-modal');
            }
        }

        function initApp() {
            document.getElementById('auth-panel').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'block';
            const h1 = document.querySelector('header p');
            if(h1) h1.innerText = `Hola, ${currentUser.full_name}`;
            
            if(currentUser.role === 'admin') {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }

            loadDashboard();
        }

        function resetConnection() {
            localStorage.removeItem('supa_url');
            localStorage.removeItem('supa_key');
            location.reload();
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            const listContainer = document.getElementById('trips-list-container');
            listContainer.innerHTML = '<p style="text-align:center; width:100%;">Cargando...</p>';

            const { data, error } = await supabaseClient.from('trips').select('*').order('created_at', { ascending: false });

            if(error) {
                listContainer.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
                return;
            }

            if(!data || data.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:var(--gray);">No tienes viajes guardados a√∫n.</p>';
                return;
            }

            listContainer.innerHTML = '';
            data.forEach(trip => {
                const info = trip.trip_data || {};
                const dest = info.destination || 'Viaje sin t√≠tulo';
                const dates = info.startDate ? new Date(info.startDate).toLocaleDateString() : '?';
                
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.onclick = () => loadTrip(trip.id, trip);

                const deleteBtn = (currentUser.role === 'admin') ? 
                    `<button class="btn-icon-small" onclick="event.stopPropagation(); deleteTrip(${trip.id})" title="Borrar"><i class="fas fa-trash"></i></button>` : '';

                card.innerHTML = `
                    <div class="trip-card-actions">${deleteBtn}</div>
                    <h3>${dest}</h3>
                    <p><i class="far fa-calendar"></i> Inicio: ${dates}</p>
                    <p style="font-size:0.75rem; color:#aaa;">ID: ${trip.id}</p>
                `;
                listContainer.appendChild(card);
            });
        }

        function showNewTripForm() {
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('setup-trip-form').style.display = 'block';
        }

        function backToDashboard() {
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'block';
            document.getElementById('summary-bar').style.display = 'none';
            loadDashboard();
        }

        // --- CREAR VIAJE ---
        async function handleCreateTrip(e) {
            e.preventDefault();
            const dest = document.getElementById('destination').value;
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const currSymbol = document.getElementById('currency-symbol').value;
            const exRate = parseFloat(document.getElementById('exchange-rate').value);
            const crcRateVal = parseFloat(document.getElementById('crc-rate').value);

            const daysList = [];
            let current = new Date(start);
            const endDateObj = new Date(end);
            while (current <= endDateObj) {
                const dateString = current.toISOString().split('T')[0];
                // AGREGAMOS daily_items VAC√çO PARA EL NUEVO SISTEMA
                daysList.push({ 
                    date: dateString, 
                    activities: [], 
                    expenses: { food: 0, transport: 0, tickets: 0 },
                    daily_items: [] 
                });
                current.setDate(current.getDate() + 1);
            }

            const newTripData = {
                destination: dest, startDate: start, endDate: end,
                currencySymbol: currSymbol, exchangeRate: exRate, crcRate: crcRateVal || 540,
                days: daysList
            };

            const { data, error } = await supabaseClient.from('trips').insert({
                user_id: currentUser.id, 
                destination: dest,
                trip_data: newTripData,
                shared_expenses: []
            }).select();

            if(error) {
                console.error("Error DB:", error);
                alert('Error creando viaje: ' + error.message + '\nAseg√∫rate de tener la columna user_id en la tabla trips.');
            } else {
                showToast('Viaje creado', 'success');
                backToDashboard();
            }
        }

        // --- CARGAR VIAJE (CORE) ---
        async function loadTrip(id, tripObj) {
            currentTripId = id;
            appData = tripObj.trip_data || appData;
            // Aseguramos compatibilidad con viajes viejos que no tienen daily_items
            appData.days = appData.days.map(d => ({
                ...d,
                daily_items: d.daily_items || []
            }));
            
            sharedExpenses = tripObj.shared_expenses || [];
            
            const { data: pExp } = await supabaseClient.from('user_trip_expenses')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('trip_id', id)
                .maybeSingle();
            
            personalExpenses = (pExp && pExp.personal_expenses) ? pExp.personal_expenses : [];

            activeDayIndex = 0;
            showPlanner();
        }

        // --- FUNCI√ìN DELETE TRIP CON BORRADO EN CASCADA ---
        async function deleteTrip(id) {
            if (currentUser.role !== 'admin') {
                showToast('Solo el administrador puede borrar viajes.', 'error');
                return;
            }

            if(!confirm("¬øEst√°s seguro de borrar este viaje? Se eliminar√°n todos los gastos y datos asociados.")) return;

            try {
                const { error: expensesError } = await supabaseClient
                    .from('user_trip_expenses')
                    .delete()
                    .eq('trip_id', id);

                if (expensesError) throw expensesError;

                const { error: tripError } = await supabaseClient
                    .from('trips')
                    .delete()
                    .eq('id', id);

                if (tripError) throw tripError;

                showToast('Viaje borrado exitosamente', 'success');
                loadDashboard();

            } catch (error) {
                console.error(error);
                showToast('Error borrando: ' + error.message, 'error');
            }
        }

        // --- UI PLANNER ---
        function showPlanner() {
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'block';
            document.getElementById('summary-bar').style.display = 'flex';

            document.getElementById('display-destination').textContent = appData.destination;
            document.getElementById('display-currency').textContent = appData.currencySymbol || 'Local';
            document.getElementById('display-rate').textContent = appData.exchangeRate;
            document.getElementById('display-crc-rate').textContent = appData.crcRate || '---';

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = `${new Date(appData.startDate).toLocaleDateString('es-ES', options)} - ${new Date(appData.endDate).toLocaleDateString('es-ES', options)}`;
            document.getElementById('display-dates').textContent = dateStr;

            renderTabs();
            renderActiveDay();
            updateTotalCost();
        }

        function renderTabs() {
            const nav = document.getElementById('tabs-nav');
            nav.innerHTML = '';
            appData.days.forEach((day, index) => {
                const dateObj = new Date(day.date);
                const shortDate = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === activeDayIndex ? 'active' : ''}`;
                btn.onclick = () => { 
                    activeDayIndex = index; 
                    editingDailyItemIndex = -1; // Resetear edici√≥n al cambiar de d√≠a
                    renderTabs(); 
                    renderActiveDay(); 
                };
                btn.innerHTML = `<span>D√≠a ${index + 1}</span><span class="tab-date">${shortDate}</span>`;
                nav.appendChild(btn);
            });
            const totalBtn = document.createElement('button');
            totalBtn.className = `tab-btn ${activeDayIndex === appData.days.length ? 'active' : ''}`;
            totalBtn.onclick = () => { activeDayIndex = appData.days.length; renderTabs(); renderActiveDay(); };
            totalBtn.innerHTML = `<span><i class="fas fa-chart-pie"></i></span><span class="tab-date">Resumen</span>`;
            nav.appendChild(totalBtn);
        }

        function renderActiveDay() {
            if (activeDayIndex === appData.days.length) { renderSummarySheet(); return; }

            const container = document.getElementById('tab-content');
            // IMPORTANTE: Aqu√≠ seleccionamos estrictamente el d√≠a activo
            const day = appData.days[activeDayIndex];
            
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;

            // --- C√ÅLCULO DE TOTALES DEL D√çA ---
            let dayTotalUSD = 0;
            
            // Actividades
            day.activities.forEach(act => { dayTotalUSD += convertToUSD(act.cost, act.currency); });
            
            // Gastos r√°pidos (Food, Transport, Tickets)
            dayTotalUSD += (parseFloat(day.expenses.food || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.transport || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.tickets || 0) / rate);

            // Items de la lista diaria (SOLO ESTE D√çA)
            const dailyItemsTotal = (day.daily_items || []).reduce((acc, item) => acc + (parseFloat(item.cost) || 0), 0);
            dayTotalUSD += (dailyItemsTotal / rate);

            const dayTotalLocal = dayTotalUSD * rate;
            const dayTotalCRC = dayTotalUSD * crcRate;
            const tripTotals = calculateTripTotals();

            const dateObj = new Date(day.date);
            const fullDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            const capitalDate = fullDate.charAt(0).toUpperCase() + fullDate.slice(1);

            // --- GASTOS COMPARTIDOS ---
            let sharedHTML = `<h4 style="margin-bottom:10px; color:var(--accent);"><i class="fas fa-users"></i> Gastos Compartidos (Admin)</h4>`;
            const sharedTotalUSD = sharedExpenses.reduce((a, b) => a + convertToUSD(b.cost, b.currency), 0);
            sharedHTML += `<div style="font-size:0.9rem; margin-bottom:5px;">Total Viaje: $${sharedTotalUSD.toFixed(2)} USD</div>`;
            
            sharedExpenses.forEach((exp, idx) => {
                const iconClass = getIconColorClass(exp.icon);
                const displayIcon = exp.icon || 'fa-receipt';
                const desc = exp.desc || 'Gasto';
                const currSym = getCurrencySymbol(exp.currency);
                
                const delBtn = (currentUser.role === 'admin') ? 
                    `<i class="fas fa-trash" style="color:red; cursor:pointer; margin-left:10px;" onclick="deleteSharedExpense(${idx})"></i>` : '';
                sharedHTML += `<div class="expense-row-list"><span><i class="fas ${displayIcon} ${iconClass}"></i> ${desc} ${delBtn}</span><span>${currSym}${parseFloat(exp.cost).toFixed(2)}</span></div>`;
            });
            if(currentUser.role === 'admin') {
                sharedHTML += `<button class="btn-primary tight" style="font-size:0.8rem; margin-top:5px;" onclick="openModal('shared-expense-modal')">+ Gasto Compartido</button>`;
            }

            // --- GASTOS PERSONALES ---
            let personalHTML = `<h4 style="margin-bottom:10px; color:var(--primary); margin-top:20px;"><i class="fas fa-user-tag"></i> Mis Gastos Personales</h4>`;
            const personalTotalUSD = personalExpenses.reduce((a, b) => a + convertToUSD(b.cost, b.currency), 0);
            personalHTML += `<div style="font-size:0.9rem; margin-bottom:5px;">Mi Total: $${personalTotalUSD.toFixed(2)} USD</div>`;

            personalExpenses.forEach((exp, idx) => {
                const iconClass = getIconColorClass(exp.icon);
                const displayIcon = exp.icon || 'fa-receipt';
                const desc = exp.desc || 'Gasto';
                const currSym = getCurrencySymbol(exp.currency);

                personalHTML += `<div class="expense-row-list"><span><i class="fas ${displayIcon} ${iconClass}"></i> ${desc} <i class="fas fa-trash" style="color:red; cursor:pointer; margin-left:10px;" onclick="deletePersonalExpense(${idx})"></i></span><span>${currSym}${parseFloat(exp.cost).toFixed(2)}</span></div>`;
            });
            personalHTML += `<button class="btn-primary tight" style="font-size:0.8rem; margin-top:5px;" onclick="openModal('personal-expense-modal')">+ Gasto Personal</button>`;

            // --- NUEVO: RENDERIZADO DE LISTA DE GASTOS DIARIOS (SOLO DEL D√çA ACTIVO) ---
            const items = day.daily_items || [];
            let dailyItemsListHTML = '<div class="daily-expense-list">';
            if (items.length > 0) {
                items.forEach((item, idx) => {
                    dailyItemsListHTML += `
                        <div class="daily-expense-list-item">
                            <span class="daily-expense-name">${item.name}</span>
                            <div style="display:flex; align-items:center;">
                                <span class="daily-expense-cost">${symbol}${parseFloat(item.cost).toFixed(2)}</span>
                                <div class="daily-expense-actions">
                                    <i class="fas fa-pen daily-expense-edit" onclick="editDailyItem(${idx})" title="Editar"></i>
                                    <i class="fas fa-trash daily-expense-delete" onclick="deleteDailyItem(${idx})" title="Eliminar"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                dailyItemsListHTML += `<div style="font-size:0.8rem; color:var(--gray); font-style:italic; padding:5px 0;">No hay gastos detallados en este d√≠a.</div>`;
            }
            dailyItemsListHTML += '</div>';

            // GESTI√ìN DEL BOT√ìN A√ëADIR/MODIFICAR
            const isEditing = editingDailyItemIndex >= 0;
            const btnText = isEditing ? "Guardar Cambios" : "A√±adir";
            const inputNameVal = isEditing ? day.daily_items[editingDailyItemIndex].name : "";
            const inputCostVal = isEditing ? day.daily_items[editingDailyItemIndex].cost : "";
            
            // Si estamos cambiando de d√≠a y no editando, limpiamos los inputs visualmente
            // (Esto se maneja re-asignando los valores en el HTML generado)

            container.innerHTML = `
                <div class="day-total-header">
                    <div class="day-title-section"><i class="far fa-calendar-alt"></i> ${capitalDate}</div>
                    <div class="totals-grid">
                        <div class="total-row"><span class="currency-label">USD</span><div class="currency-values"><span class="val-day">$${dayTotalUSD.toFixed(2)}</span> | <span class="val-trip">Viaje: $${tripTotals.usd.toFixed(2)}</span></div></div>
                        ${crcRate > 0 ? `<div class="total-row"><span class="currency-label">Col</span><div class="currency-values"><span class="val-day">‚Ç°${dayTotalCRC.toLocaleString()}</span> | <span class="val-trip">Viaje: ‚Ç°${tripTotals.crc.toLocaleString()}</span></div></div>` : ''}
                        <div class="total-row"><span class="currency-label">${symbol}</span><div class="currency-values"><span class="val-day">${formatMoney(dayTotalLocal)}</span> | <span class="val-trip">Viaje: ${formatMoney(tripTotals.local)}</span></div></div>
                    </div>
                </div>

                <div class="shared-expenses-box">${sharedHTML}</div>
                <div class="personal-expenses-box">${personalHTML}</div>

                <ul class="activity-list">${renderActivitiesListHTML(day, activeDayIndex, symbol, rate, crcRate)}</ul>
                
                <div class="daily-expenses">
                    <div class="expense-title"><i class="fas fa-list-alt"></i> Gastos Diarios (${symbol})</div>
                    
                    <!-- NUEVA LISTA DETALLADA -->
                    ${dailyItemsListHTML}
                    
                    <div style="display:flex; gap:5px; margin-bottom:15px; border-top:1px dashed #ccc; padding-top:10px;">
                        <input type="text" id="new-daily-name" placeholder="Detalle (ej: Almuerzo)" value="${inputNameVal}" style="flex:2;">
                        <input type="number" id="new-daily-cost" placeholder="Costo" value="${inputCostVal}" style="flex:1;">
                        <button class="btn-primary tight" onclick="addDailyItem()">${btnText}</button>
                        ${isEditing ? `<button class="btn-secondary tight" style="margin-top:0;" onclick="cancelEditDailyItem()">Cancelar</button>` : ''}
                    </div>

                    <div class="expense-title" style="margin-top:15px;">Totales R√°pidos</div>
                    <div class="expense-grid">
                        <div class="expense-input"><label><i class="fas fa-utensils"></i> Comida</label><input type="number" min="0" step="0.5" value="${day.expenses.food}" onchange="updateExpense(${activeDayIndex}, 'food', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-bus"></i> Transporte</label><input type="number" min="0" step="0.5" value="${day.expenses.transport}" onchange="updateExpense(${activeDayIndex}, 'transport', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-ticket-alt"></i> Entradas</label><input type="number" min="0" step="0.5" value="${day.expenses.tickets}" onchange="updateExpense(${activeDayIndex}, 'tickets', this.value)"></div>
                    </div>
                </div>
            `;
        }

        function renderActivitiesListHTML(day, dayIndex, symbol, rate, crcRate) {
            if (day.activities.length === 0) return `<li style="text-align:center; color:var(--gray); padding:2rem; border:1px dashed #ccc; border-radius:8px;">Sin actividades planeadas.</li>`;
            return day.activities.map((act, actIndex) => {
                let iconClass = getIconColorClass(act.icon);

                const iconToDisplay = act.icon || 'fa-star';
                const costVal = parseFloat(act.cost) || 0;
                const currCode = act.currency || 'local'; 
                let originalSymbol = getCurrencySymbol(currCode);
                const costUSD = convertToUSD(costVal, currCode);
                const costCRC = costUSD * crcRate;
                const costLocal = costUSD * rate; 

                const isOwner = act.created_by === currentUser.id;
                const isAdmin = currentUser.role === 'admin';
                const canDelete = isOwner || isAdmin;
                const deleteBtnStyle = canDelete ? "" : "opacity:0.3; cursor:not-allowed;";

                return `
                <li class="activity-item">
                    <div class="activity-top">
                        <div class="activity-time">${act.time}</div>
                        <div class="activity-details">
                            <div class="activity-name"><i class="fas ${iconToDisplay} ${iconClass}"></i> ${act.name}</div>
                            <div class="activity-meta"><i class="fas fa-map-marker-alt"></i> ${act.location}</div>
                            ${act.howToGet ? `<div class="activity-meta"><i class="fas fa-directions"></i> <span>${act.howToGet}</span></div>` : ''}
                            ${act.link ? `<div class="activity-meta"><i class="fas fa-globe"></i> <a href="${act.link}" target="_blank" class="activity-link">Visitar sitio web</a></div>` : ''}
                            <div style="margin-top: 8px;">
                                <div class="activity-meta" style="color: var(--dark); font-weight: bold; margin-bottom:2px;">
                                    <i class="fas fa-coins"></i> ${originalSymbol}${costVal.toFixed(2)} <span style="font-size:0.8em; font-weight:normal; color:var(--gray); text-transform:uppercase;">(${currCode})</span>
                                </div>
                                <div style="font-size:0.85em; color:var(--gray); padding-left: 20px;">
                                    <div>‚Üí $${costUSD.toFixed(2)} USD</div>
                                    ${crcRate > 0 ? `<div>‚Üí ‚Ç°${costCRC.toLocaleString()} Colones</div>` : ''}
                                    ${currCode !== 'local' ? `<div>‚Üí ${formatMoney(costLocal)} ${symbol} (Equivalente)</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn-sm btn-edit" onclick="openModal('activity-modal', ${dayIndex}, ${actIndex})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn-sm btn-delete" style="${deleteBtnStyle}" onclick="deleteActivity(${dayIndex}, ${actIndex})" title="${canDelete ? 'Borrar' : 'Solo puedes borrar lo que t√∫ a√±ades'}"><i class="fas fa-trash"></i> Borrar</button>
                    </div>
                </li>`;
            }).join('');
        }

        // --- LOGICA DE DATOS ---
        function convertToUSD(amount, currencyCode) {
            const val = parseFloat(amount) || 0;
            const code = currencyCode || 'local';
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            if (code === 'usd') return val;
            if (code === 'crc') return val / crcRate;
            return val / rate;
        }

        function formatMoney(amount) {
            return parseFloat(amount).toFixed(2);
        }

        function getCurrencySymbol(code) {
            if (code === 'usd') return '$';
            if (code === 'crc') return '‚Ç°';
            return appData.currencySymbol || '$';
        }
        
        function getIconColorClass(iconId) {
            if(!iconId) return '';
            if(['fa-utensils'].includes(iconId)) return 'act-icon-food';
            if(['fa-bus','fa-taxi','fa-subway','fa-plane'].includes(iconId)) return 'act-icon-transport';
            if(['fa-landmark','fa-university','fa-ticket-alt'].includes(iconId)) return 'act-icon-culture';
            if(['fa-bed'].includes(iconId)) return 'act-icon-lodging';
            if(['fa-tree'].includes(iconId)) return 'act-icon-nature';
            if(['fa-shopping-bag'].includes(iconId)) return 'act-icon-shopping';
            if(['fa-glass-cheers'].includes(iconId)) return 'act-icon-party';
            return '';
        }

        function updateExpense(dayIndex, type, value) {
            appData.days[dayIndex].expenses[type] = parseFloat(value) || 0;
            saveToStorage();
        }

        // --- NUEVAS FUNCIONES PARA LISTA DE GASTOS DIARIOS ---
        
        // Iniciar modo edici√≥n
        function editDailyItem(itemIndex) {
            editingDailyItemIndex = itemIndex;
            renderActiveDay(); // Re-renderizar para rellenar inputs y cambiar bot√≥n
        }

        // Cancelar modo edici√≥n
        function cancelEditDailyItem() {
            editingDailyItemIndex = -1;
            renderActiveDay();
        }

        async function addDailyItem() {
            const nameInput = document.getElementById('new-daily-name');
            const costInput = document.getElementById('new-daily-cost');
            
            const name = nameInput.value.trim();
            const cost = parseFloat(costInput.value);
            
            if (!name) {
                alert("Escribe el detalle del gasto");
                return;
            }
            if (isNaN(cost) || cost <= 0) {
                alert("Escribe un costo v√°lido");
                return;
            }

            if (!appData.days[activeDayIndex].daily_items) {
                appData.days[activeDayIndex].daily_items = [];
            }

            if (editingDailyItemIndex >= 0) {
                // MODIFICAR
                appData.days[activeDayIndex].daily_items[editingDailyItemIndex] = { name, cost };
                editingDailyItemIndex = -1; // Salir de modo edici√≥n
            } else {
                // A√ëADIR (SOLO AL D√çA ACTIVO)
                appData.days[activeDayIndex].daily_items.push({ name, cost });
            }
            
            await saveToStorage();
        }

        async function deleteDailyItem(itemIndex) {
            if(confirm("¬øBorrar este gasto de la lista?")) {
                appData.days[activeDayIndex].daily_items.splice(itemIndex, 1);
                // Si estamos editando el item que acabamos de borrar, cancelar edici√≥n
                if (editingDailyItemIndex === itemIndex) {
                    editingDailyItemIndex = -1;
                } else if (itemIndex < editingDailyItemIndex) {
                    editingDailyItemIndex--; // Ajustar √≠ndice si borramos uno anterior
                }
                await saveToStorage();
            }
        }

        // --- FIX: ROBUST SAVE LOGIC ---
        async function saveToStorage() {
            if(!currentTripId || !supabaseClient) return false;
            
            try {
                console.log("Guardando datos...");
                const cleanAppData = JSON.parse(JSON.stringify(appData));

                const { error: tripError } = await supabaseClient.from('trips')
                    .update({ 
                        trip_data: cleanAppData, 
                        shared_expenses: sharedExpenses 
                    })
                    .eq('id', currentTripId);

                if (tripError) throw tripError;

                const { data: existingExpense } = await supabaseClient.from('user_trip_expenses')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('trip_id', currentTripId)
                    .maybeSingle();
                
                let expenseError;

                if (existingExpense) {
                    const res = await supabaseClient.from('user_trip_expenses')
                        .update({ personal_expenses: personalExpenses })
                        .eq('id', existingExpense.id);
                    expenseError = res.error;
                } else {
                    const res = await supabaseClient.from('user_trip_expenses')
                        .insert({ 
                            user_id: currentUser.id, 
                            trip_id: currentTripId, 
                            personal_expenses: personalExpenses 
                        });
                    expenseError = res.error;
                }
                
                if (expenseError) throw expenseError;

                updateTotalCost();
                renderActiveDay();
                
                return true; 
                
            } catch (error) {
                console.error("Error completo al guardar:", error);
                showToast('Error al guardar: ' + error.message, 'error');
                return false; 
            }
        }

        // --- FUNCIONES GEN√âRICAS PARA GRID DE ICONOS ---
        function renderIconGrid(containerId, inputId, preselectedIcon = 'fa-star') {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = ''; 
            
            CATEGORIES.forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'icon-btn';
                btn.dataset.icon = cat.id;
                btn.dataset.cat = cat.cat;
                btn.onclick = () => selectIcon(cat.id, inputId);
                
                btn.innerHTML = `
                    <i class="fas ${cat.id}"></i>
                    <span>${cat.label}</span>
                `;
                container.appendChild(btn);
            });
            selectIcon(preselectedIcon, inputId);
        }

        function selectIcon(iconClass, inputId) {
            document.getElementById(inputId).value = iconClass;
            const container = document.getElementById(inputId).parentElement.querySelector('.icon-grid');
            if(container) {
                const buttons = container.querySelectorAll('.icon-btn');
                buttons.forEach(btn => {
                    if(btn.dataset.icon === iconClass) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                });
            }
        }

        // --- GESTI√ìN DE MODALES ---
        function openModal(modalId, param1 = null, param2 = null) {
            const modal = document.getElementById(modalId);
            if(modal) modal.classList.add('active');

            if (modalId === 'activity-modal') {
                document.getElementById('modal-day-index').value = param1;
                document.getElementById('modal-activity-index').value = param2 !== null ? param2 : '';
                const form = document.getElementById('activity-form');
                
                renderIconGrid('activity-icon-grid', 'act-icon');

                if (param2 !== null) { 
                    document.getElementById('modal-title').textContent = 'Editar Actividad';
                    const act = appData.days[param1].activities[param2];
                    selectIcon(act.icon || 'fa-star', 'act-icon');
                    document.getElementById('act-time').value = act.time;
                    document.getElementById('act-name').value = act.name;
                    document.getElementById('act-location').value = act.location;
                    document.getElementById('act-transport').value = act.howToGet;
                    document.getElementById('act-link').value = act.link;
                    document.getElementById('act-cost').value = act.cost;
                    document.getElementById('act-currency').value = act.currency || 'local';
                } else { 
                    document.getElementById('modal-title').textContent = 'A√±adir Actividad';
                    form.reset();
                    selectIcon('fa-star', 'act-icon');
                    document.getElementById('act-cost').value = 0;
                    document.getElementById('act-currency').value = 'local';
                }
            } 
            else if (modalId === 'shared-expense-modal') {
                renderIconGrid('shared-icon-grid', 'shared-icon');
                document.getElementById('shared-cost').value = '';
                document.getElementById('shared-desc').value = '';
                document.getElementById('shared-currency').value = 'local';
            }
            else if (modalId === 'personal-expense-modal') {
                renderIconGrid('personal-icon-grid', 'personal-icon');
                document.getElementById('personal-cost').value = '';
                document.getElementById('personal-desc').value = '';
                document.getElementById('personal-currency').value = 'local';
            }
        }

        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
        }
        
        async function saveActivity(e) {
            e.preventDefault();
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const actIndexStr = document.getElementById('modal-activity-index').value;
            
            const activityData = {
                icon: document.getElementById('act-icon').value,
                time: document.getElementById('act-time').value,
                name: document.getElementById('act-name').value,
                location: document.getElementById('act-location').value,
                howToGet: document.getElementById('act-transport').value,
                link: document.getElementById('act-link').value,
                cost: parseFloat(document.getElementById('act-cost').value) || 0, 
                currency: document.getElementById('act-currency').value,
                created_by: currentUser.id 
            };

            if (actIndexStr !== '') {
                const originalAct = appData.days[dayIndex].activities[parseInt(actIndexStr)];
                if(originalAct && originalAct.created_by) {
                    activityData.created_by = originalAct.created_by;
                }
                appData.days[dayIndex].activities[parseInt(actIndexStr)] = activityData;
            } else {
                appData.days[dayIndex].activities.push(activityData);
                appData.days[dayIndex].activities.sort((a, b) => a.time.localeCompare(b.time));
            }
            
            const saved = await saveToStorage();
            if (saved) {
                closeModal('activity-modal');
            }
        }

        async function deleteActivity(dayIndex, actIndex) {
            const act = appData.days[dayIndex].activities[actIndex];
            const isOwner = act.created_by === currentUser.id;
            const isAdmin = currentUser.role === 'admin';

            if (!isOwner && !isAdmin) {
                showToast("No puedes borrar esta actividad. Solo puedes borrar lo que t√∫ a√±ades.", "error");
                return;
            }

            if(confirm("¬øEliminar esta actividad?")) {
                appData.days[dayIndex].activities.splice(actIndex, 1);
                await saveToStorage();
            }
        }

        // --- GESTION GASTOS COMPARTIDOS (ADMIN) ---
        async function saveSharedExpense(e) {
            e.preventDefault();
            const icon = document.getElementById('shared-icon').value;
            const currency = document.getElementById('shared-currency').value;
            const desc = document.getElementById('shared-desc').value;
            const cost = parseFloat(document.getElementById('shared-cost').value) || 0;
            sharedExpenses.push({ icon, desc, cost, currency });
            
            const saved = await saveToStorage();
            if (saved) closeModal('shared-expense-modal');
        }
        async function deleteSharedExpense(idx) {
            if(currentUser.role !== 'admin') {
                showToast("Solo el admin puede borrar gastos compartidos.", "error");
                return;
            }
            if(confirm("¬øBorrar gasto compartido?")) {
                sharedExpenses.splice(idx, 1);
                await saveToStorage();
            }
        }

        // --- GESTION GASTOS PERSONALES (USER) ---
        async function savePersonalExpense(e) {
            e.preventDefault();
            const icon = document.getElementById('personal-icon').value;
            const currency = document.getElementById('personal-currency').value;
            const desc = document.getElementById('personal-desc').value;
            const cost = parseFloat(document.getElementById('personal-cost').value) || 0;
            personalExpenses.push({ icon, desc, cost, currency });
            
            const saved = await saveToStorage();
            if (saved) closeModal('personal-expense-modal');
        }
        async function deletePersonalExpense(idx) {
            if(confirm("¬øBorrar gasto personal?")) {
                personalExpenses.splice(idx, 1);
                await saveToStorage();
            }
        }

        // --- GESTION USUARIOS (ADMIN) - ACTUALIZADO PARA EDITAR ---
        async function openUserModal() {
            clearUserForm();
            loadUsersList();
            openModal('users-modal');
        }

        async function loadUsersList() {
            const { data } = await supabaseClient.from('app_users').select('*');
            const list = document.getElementById('users-list-ul');
            list.innerHTML = '';
            
            data.forEach(u => {
                const li = document.createElement('li');
                li.className = 'user-list-item';
                li.innerHTML = `
                    <span onclick="editUser(${u.id})" style="flex:1; cursor:pointer; font-weight:600;">${u.full_name} <small style="font-weight:400; color:#888;">(${u.email})</small></span>
                    <div class="user-list-actions">
                        <span style="font-size:0.8rem; background:${u.role==='admin'?'#fff3cd':'#f1f2f6'}; padding:2px 6px; border-radius:4px;">${u.role}</span>
                        ${u.email !== 'admin@quinchitico.com' ? `<button class="btn-sm btn-delete" onclick="event.stopPropagation(); deleteUser(${u.id})"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function clearUserForm() {
            document.getElementById('edit-user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-pass').value = '';
            document.querySelector('#users-modal form button[type="submit"]').innerText = 'Guardar Usuario';
        }

        async function editUser(id) {
            const { data } = await supabaseClient.from('app_users').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('edit-user-id').value = data.id;
                document.getElementById('user-name').value = data.full_name;
                document.getElementById('user-email').value = data.email;
                document.getElementById('user-pass').value = ''; 
                document.querySelector('#users-modal form button[type="submit"]').innerText = 'Actualizar Usuario';
                showToast('Editando usuario: ' + data.full_name, 'success');
            }
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-user-id').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;

            if(id) {
                const updateData = { full_name: name, email: email };
                if(pass) updateData.password = pass;
                
                const { error } = await supabaseClient.from('app_users').update(updateData).eq('id', id);
                if(error) showToast('Error actualizando', 'error');
                else {
                    showToast('Usuario actualizado', 'success');
                    clearUserForm();
                    loadUsersList();
                }
            } else {
                const { error } = await supabaseClient.from('app_users').insert({
                    full_name: name, email: email, password: pass, role: 'user'
                });
                if(error) showToast('Error creando', 'error');
                else {
                    showToast('Usuario creado', 'success');
                    clearUserForm();
                    loadUsersList();
                }
            }
        }

        async function deleteUser(id) {
            if(!confirm("¬øBorrar este usuario?")) return;
            const { error } = await supabaseClient.from('app_users').delete().eq('id', id);
            if(error) showToast('Error borrando', 'error');
            else loadUsersList();
        }

        // --- RESUMEN ---
        function renderSummarySheet() {
            const container = document.getElementById('tab-content');
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            const totals = calculateTripTotals();
            const breakdown = calculateCategoryBreakdown();

            const dailyTotals = appData.days.map((day, idx) => {
                let totalUSD = 0;
                day.activities.forEach(a => totalUSD += convertToUSD(a.cost, a.currency));
                totalUSD += (parseFloat(day.expenses.food || 0) / rate);
                totalUSD += (parseFloat(day.expenses.transport || 0) / rate);
                totalUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                // Incluir items diarios
                const dailyItems = (day.daily_items || []).reduce((acc, i) => acc + (i.cost || 0), 0);
                totalUSD += (dailyItems / rate);

                return { idx: idx + 1, date: day.date, total: totalUSD };
            }).sort((a,b) => b.total - a.total);

            container.innerHTML = `
                <div class="summary-card">
                    <h2 class="summary-title">Resumen Financiero</h2>
                    <div class="big-totals">
                        <div class="big-total-item"><span class="bt-label">D√≥lares (USD)</span><span class="bt-value">$${totals.usd.toFixed(2)}</span></div>
                        ${crcRate > 0 ? `<div class="big-total-item"><span class="bt-label">Colones (CRC)</span><span class="bt-value">‚Ç°${totals.crc.toLocaleString()}</span></div>` : ''}
                        <div class="big-total-item"><span class="bt-label">${symbol} (Local)</span><span class="bt-value">${formatMoney(totals.local)}</span></div>
                    </div>
                    <div class="summary-grid">
                        <div class="breakdown-section">
                            <h3>Por Categor√≠a</h3>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-utensils" style="color:#e17055;"></i> Comida</span><span class="cat-val">$${breakdown.foodUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-bus" style="color:#0984e3;"></i> Transporte</span><span class="cat-val">$${breakdown.transportUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-ticket-alt" style="color:#fdcb6e;"></i> Entradas</span><span class="cat-val">$${breakdown.ticketsUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-list" style="color:#b2bec3;"></i> Actividades</span><span class="cat-val">$${breakdown.activitiesUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-receipt" style="color:#2ecc71;"></i> Otros Diarios</span><span class="cat-val">$${breakdown.dailyItemsUSD.toFixed(2)}</span></div>
                        </div>
                        <div class="breakdown-section">
                            <h3>D√≠as m√°s costosos</h3>
                            ${dailyTotals.map(d => `<div class="breakdown-row"><span class="cat-name">D√≠a ${d.idx}</span><span class="cat-val">$${d.total.toFixed(2)}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function calculateCategoryBreakdown() {
            let foodUSD = 0, transportUSD = 0, ticketsUSD = 0, activitiesUSD = 0, dailyItemsUSD = 0;
            const rate = appData.exchangeRate || 1;
            appData.days.forEach(day => {
                foodUSD += (parseFloat(day.expenses.food || 0) / rate);
                transportUSD += (parseFloat(day.expenses.transport || 0) / rate);
                ticketsUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                day.activities.forEach(act => { activitiesUSD += convertToUSD(act.cost, act.currency); });
                
                // NUEVO: C√°lculo de items diarios
                const items = (day.daily_items || []).reduce((acc, i) => acc + (i.cost || 0), 0);
                dailyItemsUSD += (items / rate);
            });
            return { foodUSD, transportUSD, ticketsUSD, activitiesUSD, dailyItemsUSD };
        }

        function calculateTripTotals() {
            let grandTotalUSD = 0;
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            appData.days.forEach(day => {
                day.activities.forEach(act => { grandTotalUSD += convertToUSD(act.cost, act.currency); });
                grandTotalUSD += (parseFloat(day.expenses.food || 0) / rate);
                grandTotalUSD += (parseFloat(day.expenses.transport || 0) / rate);
                grandTotalUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                
                // NUEVO: Suma de items diarios
                const items = (day.daily_items || []).reduce((acc, i) => acc + (i.cost || 0), 0);
                grandTotalUSD += (items / rate);
            });
            sharedExpenses.forEach(exp => { grandTotalUSD += convertToUSD(exp.cost, exp.currency); });
            personalExpenses.forEach(exp => { grandTotalUSD += convertToUSD(exp.cost, exp.currency); });

            return { usd: grandTotalUSD, crc: grandTotalUSD * crcRate, local: grandTotalUSD * rate };
        }

        function updateTotalCost() {
            const tripTotals = calculateTripTotals();
            document.getElementById('grand-total').textContent = '$' + tripTotals.usd.toFixed(2) + ' USD';
            const crcRate = appData.crcRate || 0;
            if(crcRate > 0) {
                document.getElementById('grand-total-crc').textContent = '‚Ç°' + tripTotals.crc.toLocaleString() + ' Colones';
                document.getElementById('grand-total-crc').style.display = 'block';
            } else { document.getElementById('grand-total-crc').style.display = 'none'; }
        }

        // --- UTILIDADES ---
        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerText = msg;
            document.getElementById('toast-area').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function fillCurrencyFromPreset() {
            const select = document.getElementById('preset-currency');
            const value = select.value;
            if(value) {
                const [symbol, rate] = value.split('|');
                document.getElementById('currency-symbol').value = symbol;
                document.getElementById('exchange-rate').value = rate;
            }
        }

        function openRateModal() {
            document.getElementById('rate-modal-symbol').textContent = appData.currencySymbol || 'local';
            document.getElementById('new-exchange-rate').value = appData.exchangeRate;
            document.getElementById('new-crc-rate').value = appData.crcRate || 540;
            document.getElementById('rate-modal').classList.add('active');
        }

        async function saveNewRates() {
            const newRate = parseFloat(document.getElementById('new-exchange-rate').value);
            const newCrcRate = parseFloat(document.getElementById('new-crc-rate').value);
            if(newRate > 0) {
                appData.exchangeRate = newRate;
                appData.crcRate = newCrcRate > 0 ? newCrcRate : 0;
                await saveToStorage();
                document.getElementById('display-rate').textContent = newRate;
                document.getElementById('display-crc-rate').textContent = newCrcRate;
                closeModal('rate-modal');
                showToast('Tipos de cambio actualizados', 'success');
            } else {
                alert("El tipo de cambio debe ser mayor a 0");
            }
        }
    </script>
</body>
</html>
```
