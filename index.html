```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quinchitico Tour - Gestor Pro</title>
    
    <!-- Iconos y Estilos -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%2300cec9' d='M498.4 228.5L285.2 25.3c-4.3-4.1-10.2-6.1-16.1-5.5l-224 22.4c-6.6.7-12.4 4.7-15.4 10.7L3.4 252.1c-3.8 7.5-2.7 16.6 2.7 23l193 228.7c4.4 5.2 11.1 8.1 18 7.6l256-20c6.9-.5 13.1-4.5 16.3-10.7l22.4-44.8c2.8-5.6 2.4-12.2-1-17.4L498.4 228.5z'/></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS ORIGINALES RESTAURADOS + NUEVOS --- */
        :root {
            --primary: #00cec9;
            --primary-dark: #00b894;
            --secondary: #0984e3;
            --accent: #fdcb6e;
            --danger: #ff7675;
            --dark: #2d3436;
            --light: #f5f6fa;
            --white: #ffffff;
            --gray: #b2bec3;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }

        body { background-color: var(--light); color: var(--dark); padding-bottom: 100px; }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        header h1 { font-size: 2rem; margin-bottom: 0.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        header p { font-size: 1rem; opacity: 0.9; }

        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }

        /* --- DASHBOARD & SETUP --- */
        #dashboard-panel, #setup-trip-form, #connection-panel {
            background: var(--white); padding: 2rem; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-top: -20px; text-align: center;
        }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-row { display: flex; gap: 1rem; }
        .form-row .form-group { flex: 1; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark); font-size: 0.9rem; }

        input, select, textarea {
            width: 100%; padding: 0.7rem; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 0.95rem; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-primary {
            background-color: var(--secondary); color: white; border: none; padding: 0.8rem 2rem;
            font-size: 1rem; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold;
            transition: transform 0.2s, background 0.3s; margin-top: 1rem;
        }
        .btn-primary:hover { background-color: #0769b5; transform: translateY(-2px); }

        .btn-secondary {
            background-color: var(--gray); color: white; border: none; padding: 0.6rem 1.5rem;
            font-size: 0.9rem; border-radius: 8px; cursor: pointer; margin-top: 1rem; margin-right: 10px;
        }

        /* Lista de Viajes */
        .trip-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .trip-card {
            background: #f8f9fa; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem;
            text-align: left; cursor: pointer; transition: 0.2s; position: relative;
        }
        .trip-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow); }
        .trip-card h3 { color: var(--dark); margin-bottom: 0.5rem; }
        .trip-card p { color: var(--gray); font-size: 0.85rem; margin-bottom: 0.2rem; }
        .trip-card-actions { position: absolute; top: 10px; right: 10px; }
        .btn-icon-small { background: none; border: none; color: var(--gray); cursor: pointer; padding: 5px; }
        .btn-icon-small:hover { color: var(--danger); }

        /* --- PANEL PLANIFICADOR --- */
        #planner-panel { display: none; animation: fadeIn 0.5s ease-in; }

        .trip-header-info {
            background: var(--white); padding: 1rem; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 1rem; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .trip-title { font-size: 1.3rem; color: var(--secondary); font-weight: 800; }
        .currency-info { text-align: right; font-size: 0.85rem; }
        .btn-back { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 20px; cursor: pointer; margin-right: 10px; }

        /* --- TABS & ACTIVITIES --- */
        .tabs-wrapper { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-top: 1rem; }
        .tabs-nav { display: flex; background: #f1f2f6; overflow-x: auto; border-bottom: 2px solid #dfe6e9; position: sticky; top: 0; z-index: 10; }
        .tabs-nav::-webkit-scrollbar { height: 4px; }
        .tab-btn { padding: 1rem 1.2rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--gray); white-space: nowrap; transition: 0.3s; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; min-width: 90px; }
        .tab-btn:hover { background: #e0e0e0; color: var(--dark); }
        .tab-btn.active { color: var(--primary); background: white; border-bottom: 3px solid var(--primary); }
        .tab-date { font-size: 0.75rem; font-weight: normal; margin-top: 2px; }

        /* Summary Tab */
        .tab-btn.summary-tab { border-left: 2px solid #dfe6e9; margin-left: 5px; }
        .tab-btn.summary-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Activity List */
        .day-total-header { background: #e0f7fa; border: 1px solid #b2bec3; border-radius: 8px; margin-bottom: 1.5rem; text-align: left; overflow: hidden; }
        .day-title-section { background: #00cec9; color: white; padding: 0.8rem 1rem; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .totals-grid { padding: 1rem; display: flex; flex-direction: column; gap: 8px; background: white; }
        .total-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .currency-label { font-weight: bold; color: var(--dark); min-width: 50px; }
        .currency-values { text-align: right; font-size: 0.95rem; }
        .val-day { font-weight: bold; color: var(--secondary); margin-right: 10px; }
        .val-trip { color: var(--gray); font-size: 0.85rem; }

        .activity-list { list-style: none; margin-bottom:1.5rem; }
        .activity-item { display: flex; flex-direction: column; padding: 1rem; border-bottom: 1px solid #f1f2f6; position: relative; transition: background 0.2s; border-radius: 8px; }
        .activity-item:hover { background-color: #fdfdfd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .activity-top { display: flex; align-items: flex-start; gap: 1rem; }
        .activity-time { font-weight: bold; color: var(--secondary); min-width: 60px; font-size: 0.95rem; padding-top: 2px; }
        .activity-details { flex-grow: 1; }
        .activity-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; display: flex; align-items: center; gap: 8px; }
        .activity-meta { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.2rem; display: flex; align-items: center; gap: 0.5rem; }
        .activity-link { color: var(--secondary); text-decoration: none; font-weight: 600; }
        .activity-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 4px; }
        .btn-edit { background: #e0f7fa; color: var(--secondary); }
        .btn-delete { background: #ffebee; color: var(--danger); }

        /* CLASES DE COLORES DE ICONOS (RESTAURADAS) */
        .act-icon-general { color: var(--gray); }
        .act-icon-food { color: #e17055; }
        .act-icon-transport { color: #0984e3; }
        .act-icon-culture { color: #fdcb6e; }
        .act-icon-travel { color: #00cec9; }
        .act-icon-lodging { color: #6c5ce7; }
        .act-icon-nature { color: #00b894; }
        .act-icon-shopping { color: #e84393; }
        .act-icon-party { color: #a29bfe; }

        .btn-add-activity { width: 100%; padding: 1rem; background: white; border: 2px dashed var(--primary); color: var(--primary); border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; margin-bottom: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
        .btn-add-activity:hover { background: #e0fffa; }

        .daily-expenses { background-color: #fdfdfd; border: 1px solid #dfe6e9; border-radius: 8px; padding: 1rem; }
        .expense-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom:1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .expense-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .expense-input label { font-size: 0.8rem; color: var(--gray); margin-bottom: 0.2rem; display: flex; align-items: center; gap: 5px; }

        /* SECCIONES NUEVAS (GASTOS COMPARTIDOS/PERSONALES) */
        .shared-expenses-box { border: 1px solid #fdcb6e; background: #fffbf0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .personal-expenses-box { border: 1px solid #00cec9; background: #e0fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .expense-row-list { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.9rem; cursor: pointer; }
        .expense-row-list:hover { background: rgba(0,0,0,0.02); }

        /* Summary Styles */
        .summary-card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .summary-title { font-size: 1.5rem; color: var(--secondary); margin-bottom: 1.5rem; font-weight: bold; }
        .big-totals { display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-bottom: 2rem; }
        .big-total-item { flex: 1; min-width: 150px; padding: 1.5rem; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; }
        .bt-label { display: block; font-size: 0.9rem; color: var(--gray); text-transform: uppercase; margin-bottom: 0.5rem; }
        .bt-value { display: block; font-size: 1.8rem; font-weight: 800; color: var(--dark); }
        .bt-value.usd { color: var(--secondary); }
        .bt-value.crc { color: var(--primary); }
        .bt-value.local { color: var(--accent); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; text-align: left; }
        .breakdown-section h3 { font-size: 1.1rem; color: var(--dark); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #eee; }
        .breakdown-row { display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px dashed #eee; }
        .cat-name { font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .cat-val { font-weight: bold; color: var(--secondary); }

        /* --- FLOATING BAR --- */
        .floating-summary { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--dark); color: white; padding: 0.8rem 2rem; display: flex; justify-content: center; align-items: center; gap: 0.3rem; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); z-index: 100; }
        .floating-summary .total-amount { font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .floating-summary .total-crc { font-size: 1rem; color: var(--primary); font-weight: bold; margin-left: 15px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; padding: 2rem; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom:1.5rem; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }

        /* Auth Specific */
        .auth-container { max-width: 400px; margin: 50px auto; }
        .user-badge { position: absolute; top: 1rem; right: 1rem; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #aaa; }
        .status-dot.connected { background: #2ecc71; }
        .admin-only-btn { display: none; }
        .admin-mode .admin-only-btn { display: inline-block; }
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .user-list-actions button { margin-left: 5px; font-size: 0.8rem; padding: 4px 8px; }

        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 2000; animation: slideIn 0.3s; }
        .toast.success { border-left: 4px solid #2ecc71; }
        .toast.error { border-left: 4px solid #e74c3c; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            .summary-grid { grid-template-columns: 1fr; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div id="connection-status-badge" style="display:none;">
            <div class="status-dot" id="status-dot"></div> <span id="status-text">Conectado</span>
        </div>
        <h1><i class="fas fa-plane-departure"></i> Quinchitico Tour</h1>
        <p>Planifica y gestiona tus viajes</p>
    </header>

    <!-- 1. AUTH / LOGIN PANEL -->
    <div id="auth-panel" class="container auth-container" style="display:none;">
        <div class="card">
            <h2 style="margin-bottom:1rem;">Iniciar SesiÃ³n</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group"><input type="email" id="login-email" placeholder="Correo" required></div>
                <div class="form-group"><input type="password" id="login-pass" placeholder="ContraseÃ±a" required></div>
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
            <button class="btn-secondary" style="width:100%; margin-top:10px;" onclick="openModal('register-modal')">Crear Cuenta</button>
            <button class="btn-secondary" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="resetConnection()">Cambiar BD</button>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div class="container" id="dashboard-panel" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2>Mis Viajes</h2>
            <button id="btn-manage-users" class="btn-primary admin-only-btn" onclick="openUserModal()" style="width:auto; padding:0.5rem 1rem; font-size:0.9rem;">
                <i class="fas fa-users-cog"></i> Usuarios
            </button>
        </div>
        
        <button class="btn-primary" onclick="showNewTripForm()">
            <i class="fas fa-plus"></i> Crear Nuevo Itinerario
        </button>

        <div id="trips-list-container" class="trip-list">
            <!-- JS render -->
        </div>
    </div>

    <!-- 3. FORMULARIO NUEVO VIAJE -->
    <div class="container" id="setup-trip-form" style="display:none;">
        <div class="card" style="text-align:left;">
            <h2 style="margin-bottom: 1rem; cursor:pointer; color:var(--secondary);" onclick="backToDashboard()">
                <i class="fas fa-arrow-left"></i> Volver / Cancelar
            </h2>
            <form id="trip-form" onsubmit="handleCreateTrip(event)">
                <div class="form-group">
                    <label for="destination">Destino del Viaje</label>
                    <input type="text" id="destination" placeholder="Ej: ParÃ­s, Tokyo" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Inicio</label>
                        <input type="date" id="start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="end-date">Fin</label>
                        <input type="date" id="end-date" required>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 1rem 0;">
                
                <div class="form-group">
                    <label>Seleccionar Moneda Principal</label>
                    <select id="preset-currency" onchange="fillCurrencyFromPreset()">
                        <option value="">-- O haz clic para seleccionar --</option>
                        <option value="USD|1">ðŸ‡ºðŸ‡¸ USD - DÃ³lar Americano</option>
                        <option value="MXN|18">ðŸ‡²ðŸ‡½ MXN - Peso Mexicano</option>
                        <option value="EUR|0.95">ðŸ‡ªðŸ‡º EUR - Euro</option>
                        <option value="CRC|540">ðŸ‡¨ðŸ‡· CRC - ColÃ³n Costarricense</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="currency-symbol">Moneda (SÃ­mbolo)</label>
                        <input type="text" id="currency-symbol" placeholder="$" value="$" required>
                    </div>
                    <div class="form-group">
                        <label for="exchange-rate">Tipo de Cambio (1 USD)</label>
                        <input type="number" id="exchange-rate" placeholder="Â¿CuÃ¡nto de tu moneda es 1 USD?" step="0.01" value="1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="crc-rate">Tipo de cambio a Colones (1 USD = ? Colones)</label>
                    <input type="number" id="crc-rate" placeholder="Ej: 540" step="1" value="540">
                    <p style="font-size: 0.75rem; color: var(--gray); margin-top: 2px;">Necesario para calcular los totales en Colones.</p>
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Crear y Guardar en Base de Datos
                </button>
            </form>
        </div>
    </div>

    <!-- 4. PANEL PLANIFICADOR -->
    <div class="container" id="planner-panel">
        <div class="trip-header-info">
            <div>
                <button class="btn-back" onclick="backToDashboard()"><i class="fas fa-arrow-left"></i> Volver</button>
                <div class="trip-title" id="display-destination">Destino</div>
                <small id="display-dates" style="color:var(--gray)">Fechas</small>
            </div>
            <div class="currency-info">
                <div>
                    <strong id="display-currency">USD</strong>
                    <button class="btn-edit-rate" onclick="openRateModal()" title="Editar tipos de cambio" style="background:none; border:1px solid #ccc; border-radius:4px; padding:2px 6px; cursor:pointer;">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <div>1 USD = <strong id="display-rate">1</strong> <small>(Local)</small></div>
                <div>1 USD = <strong id="display-crc-rate">540</strong> <small>(Col)</small></div>
            </div>
        </div>

        <div class="tabs-wrapper">
            <nav class="tabs-nav" id="tabs-nav"></nav>
            <div class="tab-content" id="tab-content"></div>
        </div>

        <br><br>
    </div>

    <!-- Barra Flotante -->
    <div id="summary-bar" class="floating-summary" style="display: none;">
        <div style="font-size: 0.8rem; text-transform: uppercase;">Total del Viaje:</div>
        <div class="total-amount" id="grand-total">$0.00 USD</div>
        <div class="total-crc" id="grand-total-crc">â‚¡0 Colones</div>
    </div>

    <!-- MODAL ACTIVIDAD -->
    <div class="modal-overlay" id="activity-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">AÃ±adir Actividad</h3>
                <button class="close-modal" onclick="closeModal('activity-modal')">&times;</button>
            </div>
            <form id="activity-form" onsubmit="saveActivity(event)">
                <input type="hidden" id="modal-day-index">
                <input type="hidden" id="modal-activity-index">
                <div class="form-group">
                    <label>CategorÃ­a / Icono</label>
                    <select id="act-icon">
                        <option value="fa-star">General</option>
                        <option value="fa-utensils">Comida</option>
                        <option value="fa-bus">Transporte (Bus/Taxi)</option>
                        <option value="fa-landmark">Museo / Cultura</option>
                        <option value="fa-plane">AviÃ³n / Viaje</option>
                        <option value="fa-bed">Hotel / Alojamiento</option>
                        <option value="fa-tree">Naturaleza / Parque</option>
                        <option value="fa-shopping-bag">Compras</option>
                        <option value="fa-glass-cheers">Fiesta / Noche</option>
                    </select>
                </div>
                <div class="form-group"><label>Hora</label><input type="time" id="act-time" required></div>
                <div class="form-group"><label>Nombre de la Actividad / Lugar</label><input type="text" id="act-name" placeholder="Ej: Visita al Museo" required></div>
                <div class="form-group"><label>UbicaciÃ³n</label><input type="text" id="act-location" placeholder="DirecciÃ³n o Punto de referencia"></div>
                <div class="form-group"><label>CÃ³mo llegar</label><input type="text" id="act-transport" placeholder="Ej: Metro Linea 3, Caminando 10min"></div>
                <div class="form-group"><label>Sitio Web (Opcional)</label><input type="url" id="act-link" placeholder="https://..."></div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="act-currency">Moneda</label>
                        <select id="act-currency">
                            <option value="local">Local</option>
                            <option value="usd">USD</option>
                            <option value="crc">Colones (CRC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-act-cost">Costo</label>
                        <input type="number" id="act-cost" min="0" step="0.01" value="0" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Guardar Actividad</button>
            </form>
        </div>
    </div>

    <!-- MODAL GESTION USUARIOS (ADMIN) -->
    <div class="modal-overlay" id="users-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Gestionar Usuarios</h3>
                <button class="close-modal" onclick="closeModal('users-modal')">&times;</button>
            </div>
            
            <form onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="edit-user-id">
                <div class="form-group"><label>Nombre</label><input type="text" id="user-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="user-pass" placeholder="Dejar vacÃ­o para mantener actual" ></div>
                <button type="submit" class="btn-primary">Guardar Usuario</button>
                <button type="button" class="btn-secondary" style="width:100%; margin-top:10px;" onclick="clearUserForm()">Limpiar / Crear Nuevo</button>
            </form>
            
            <hr style="margin: 1.5rem 0;">
            <h4>Usuarios Existentes (Clic para editar)</h4>
            <ul id="users-list-ul" style="list-style:none; max-height:200px; overflow-y:auto; font-size:0.9rem; padding:0;"></ul>
        </div>
    </div>

    <!-- MODAL REGISTRO -->
    <div class="modal-overlay" id="register-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Crear Cuenta</h3>
                <button class="close-modal" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <form onsubmit="handleRegister(event)">
                <div class="form-group"><label>Nombre</label><input type="text" id="reg-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="reg-email" required></div>
                <div class="form-group"><label>ContraseÃ±a</label><input type="password" id="reg-pass" required></div>
                <button type="submit" class="btn-primary">Registrarse</button>
                <button type="button" class="btn-secondary" onclick="closeModal('register-modal')" style="width:100%; margin-top:10px;">Volver</button>
            </form>
        </div>
    </div>

    <!-- MODAL GASTO COMPARTIDO (ADMIN) -->
    <div class="modal-overlay" id="shared-expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Gasto Compartido (Admin)</h3>
                <button class="close-modal" onclick="closeModal('shared-expense-modal')">&times;</button>
            </div>
            <form onsubmit="saveSharedExpense(event)">
                <div class="form-group"><label>DescripciÃ³n</label><input type="text" id="shared-desc" placeholder="Ej: Hotel Noche 1" required></div>
                <div class="form-group"><label>Costo Total</label><input type="number" id="shared-cost" step="0.01" required></div>
                <button type="submit" class="btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <!-- MODAL GASTO PERSONAL (USER) -->
    <div class="modal-overlay" id="personal-expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Mi Gasto Personal</h3>
                <button class="close-modal" onclick="closeModal('personal-expense-modal')">&times;</button>
            </div>
            <form onsubmit="savePersonalExpense(event)">
                <div class="form-group"><label>DescripciÃ³n</label><input type="text" id="personal-desc" placeholder="Ej: Souvenir, Compras" required></div>
                <div class="form-group"><label>Costo</label><input type="number" id="personal-cost" step="0.01" required></div>
                <button type="submit" class="btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Tipo de Cambio -->
    <div class="modal-overlay" id="rate-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Editar Tipos de Cambio</h3>
                <button class="close-modal" onclick="closeModal('rate-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Cambio USD a Local (1 USD = ? <span id="rate-modal-symbol"></span>)</label>
                <input type="number" id="new-exchange-rate" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Cambio USD a Colones (1 USD = ? Colones)</label>
                <input type="number" id="new-crc-rate" step="1" value="540">
            </div>
            <button class="btn-primary" onclick="saveNewRates()">Actualizar</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-area"></div>

    <script>
        // --- CREDENCIALES AUTOMATICAS ---
        const AUTO_URL = "https://orinqfthcxrzcjgkmrmd.supabase.co";
        const AUTO_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yaW5xZnRoY3hyemNqZ2ttcm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDcyMzksImV4cCI6MjA4NTk4MzIzOX0.fzAlGiGozWJsFROtg0cbSymHWlUKkb-eQpNXpVRIOPY";

        // --- VARIABLES GLOBALES ---
        let supabaseClient = null;
        let currentUser = null;
        let currentTripId = null;
        
        let appData = {
            destination: "", startDate: "", endDate: "", currencySymbol: "$", exchangeRate: 1, crcRate: 540, days: []
        };
        let sharedExpenses = [];
        let personalExpenses = [];
        let activeDayIndex = 0;

        // --- INICIALIZACIÃ“N ---
        document.addEventListener('DOMContentLoaded', async () => {
            const url = localStorage.getItem('supa_url') || AUTO_URL;
            const key = localStorage.getItem('supa_key') || AUTO_KEY;

            try {
                const { createClient } = window.supabase;
                supabaseClient = createClient(url, key);
                const { error } = await supabaseClient.from('app_users').select('id').limit(1);
                if(error) throw error;

                document.getElementById('connection-status-badge').style.display = 'flex';
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').innerText = 'Conectado';

                localStorage.setItem('supa_url', url);
                localStorage.setItem('supa_key', key);

                const lastEmail = localStorage.getItem('last_user_email');
                if(lastEmail) document.getElementById('login-email').value = lastEmail;

                showAuthPanel();

            } catch (e) {
                console.error(e);
                alert("Error de conexiÃ³n. AsegÃºrate de haber ejecutado el SQL en Supabase.");
            }
        });

        // --- AUTH PANEL LOGIC ---
        function showAuthPanel() {
            document.getElementById('auth-panel').style.display = 'block';
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;

            const { data, error } = await supabaseClient
                .from('app_users')
                .select('*')
                .eq('email', email)
                .eq('password', pass)
                .single();

            if (error || !data) {
                showToast('Credenciales incorrectas', 'error');
            } else {
                currentUser = data;
                localStorage.setItem('last_user_email', email);
                initApp();
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            const { data: exist } = await supabaseClient.from('app_users').select('id').eq('email', email).single();
            if(exist) return showToast('Email ya registrado', 'error');

            const { count } = await supabaseClient.from('app_users').select('*', { count: 'exact', head: true });
            const role = count === 0 ? 'admin' : 'user';

            const { error } = await supabaseClient.from('app_users').insert({
                full_name: name, email: email, password: pass, role: role
            });

            if(error) showToast('Error registrando', 'error');
            else {
                showToast('Cuenta creada', 'success');
                closeModal('register-modal');
            }
        }

        function initApp() {
            document.getElementById('auth-panel').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'block';
            document.getElementById('header-subtitle')?.remove();
            const h1 = document.querySelector('header p');
            if(h1) h1.innerText = `Hola, ${currentUser.full_name}`;
            
            if(currentUser.role === 'admin') {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }

            loadDashboard();
        }

        function resetConnection() {
            localStorage.removeItem('supa_url');
            localStorage.removeItem('supa_key');
            location.reload();
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            const listContainer = document.getElementById('trips-list-container');
            listContainer.innerHTML = '<p style="text-align:center; width:100%;">Cargando...</p>';

            const { data, error } = await supabaseClient.from('trips').select('*').order('created_at', { ascending: false });

            if(error) {
                listContainer.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
                return;
            }

            if(!data || data.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:var(--gray);">No tienes viajes guardados aÃºn.</p>';
                return;
            }

            listContainer.innerHTML = '';
            data.forEach(trip => {
                const info = trip.trip_data || {};
                const dest = info.destination || 'Viaje sin tÃ­tulo';
                const dates = info.startDate ? new Date(info.startDate).toLocaleDateString() : '?';
                
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.onclick = () => loadTrip(trip.id, trip);

                const deleteBtn = (currentUser.role === 'admin') ? 
                    `<button class="btn-icon-small" onclick="event.stopPropagation(); deleteTrip(${trip.id})" title="Borrar"><i class="fas fa-trash"></i></button>` : '';

                card.innerHTML = `
                    <div class="trip-card-actions">${deleteBtn}</div>
                    <h3>${dest}</h3>
                    <p><i class="far fa-calendar"></i> Inicio: ${dates}</p>
                    <p style="font-size:0.75rem; color:#aaa;">ID: ${trip.id}</p>
                `;
                listContainer.appendChild(card);
            });
        }

        function showNewTripForm() {
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('setup-trip-form').style.display = 'block';
        }

        function backToDashboard() {
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'block';
            document.getElementById('summary-bar').style.display = 'none';
            loadDashboard();
        }

        // --- CREAR VIAJE ---
        async function handleCreateTrip(e) {
            e.preventDefault();
            const dest = document.getElementById('destination').value;
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const currSymbol = document.getElementById('currency-symbol').value;
            const exRate = parseFloat(document.getElementById('exchange-rate').value);
            const crcRateVal = parseFloat(document.getElementById('crc-rate').value);

            const daysList = [];
            let current = new Date(start);
            const endDateObj = new Date(end);
            while (current <= endDateObj) {
                const dateString = current.toISOString().split('T')[0];
                daysList.push({ date: dateString, activities: [], expenses: { food: 0, transport: 0, tickets: 0 } });
                current.setDate(current.getDate() + 1);
            }

            const newTripData = {
                destination: dest, startDate: start, endDate: end,
                currencySymbol: currSymbol, exchangeRate: exRate, crcRate: crcRateVal || 540,
                days: daysList
            };

            const { data, error } = await supabaseClient.from('trips').insert({
                destination: dest,
                trip_data: newTripData,
                shared_expenses: []
            }).select();

            if(error) {
                showToast('Error guardando: ' + error.message, 'error');
            } else {
                showToast('Viaje creado', 'success');
                backToDashboard();
            }
        }

        // --- CARGAR VIAJE (CORE) ---
        async function loadTrip(id, tripObj) {
            currentTripId = id;
            appData = tripObj.trip_data || appData;
            sharedExpenses = tripObj.shared_expenses || [];
            
            const { data: pExp } = await supabaseClient.from('user_trip_expenses')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('trip_id', id)
                .single();
            
            personalExpenses = (pExp && pExp.personal_expenses) ? pExp.personal_expenses : [];

            activeDayIndex = 0;
            showPlanner();
        }

        async function deleteTrip(id) {
            if(!confirm("Â¿Borrar viaje?")) return;
            const { error } = await supabaseClient.from('trips').delete().eq('id', id);
            if(error) showToast('Error borrando', 'error');
            else loadDashboard();
        }

        // --- UI PLANNER ---
        function showPlanner() {
            document.getElementById('setup-trip-form').style.display = 'none';
            document.getElementById('dashboard-panel').style.display = 'none';
            document.getElementById('planner-panel').style.display = 'block';
            document.getElementById('summary-bar').style.display = 'flex';

            document.getElementById('display-destination').textContent = appData.destination;
            document.getElementById('display-currency').textContent = appData.currencySymbol || 'Local';
            document.getElementById('display-rate').textContent = appData.exchangeRate;
            document.getElementById('display-crc-rate').textContent = appData.crcRate || '---';

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = `${new Date(appData.startDate).toLocaleDateString('es-ES', options)} - ${new Date(appData.endDate).toLocaleDateString('es-ES', options)}`;
            document.getElementById('display-dates').textContent = dateStr;

            renderTabs();
            renderActiveDay();
            updateTotalCost();
        }

        function renderTabs() {
            const nav = document.getElementById('tabs-nav');
            nav.innerHTML = '';
            appData.days.forEach((day, index) => {
                const dateObj = new Date(day.date);
                const shortDate = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === activeDayIndex ? 'active' : ''}`;
                btn.onclick = () => { activeDayIndex = index; renderTabs(); renderActiveDay(); };
                btn.innerHTML = `<span>DÃ­a ${index + 1}</span><span class="tab-date">${shortDate}</span>`;
                nav.appendChild(btn);
            });
            const totalBtn = document.createElement('button');
            totalBtn.className = `tab-btn summary-tab ${activeDayIndex === appData.days.length ? 'active' : ''}`;
            totalBtn.onclick = () => { activeDayIndex = appData.days.length; renderTabs(); renderActiveDay(); };
            totalBtn.innerHTML = `<span><i class="fas fa-chart-pie"></i></span><span class="tab-date">Resumen</span>`;
            nav.appendChild(totalBtn);
        }

        function renderActiveDay() {
            if (activeDayIndex === appData.days.length) { renderSummarySheet(); return; }

            const container = document.getElementById('tab-content');
            const day = appData.days[activeDayIndex];
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate;
            const crcRate = appData.crcRate || 0;

            let dayTotalUSD = 0;
            day.activities.forEach(act => { dayTotalUSD += convertToUSD(act.cost, act.currency); });
            dayTotalUSD += (parseFloat(day.expenses.food || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.transport || 0) / rate);
            dayTotalUSD += (parseFloat(day.expenses.tickets || 0) / rate);

            const dayTotalLocal = dayTotalUSD * rate;
            const dayTotalCRC = dayTotalUSD * crcRate;
            const tripTotals = calculateTripTotals();

            const dateObj = new Date(day.date);
            const fullDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            const capitalDate = fullDate.charAt(0).toUpperCase() + fullDate.slice(1);

            // Gastos Compartidos
            let sharedHTML = `<h4 style="margin-bottom:10px; color:var(--accent);"><i class="fas fa-users"></i> Gastos Compartidos (Admin)</h4>`;
            const sharedTotal = sharedExpenses.reduce((a, b) => a + parseFloat(b.cost), 0);
            sharedHTML += `<div style="font-size:0.9rem; margin-bottom:5px;">Total Viaje: ${symbol}${sharedTotal.toFixed(2)}</div>`;
            
            sharedExpenses.forEach((exp, idx) => {
                const delBtn = (currentUser.role === 'admin') ? 
                    `<i class="fas fa-trash" style="color:red; cursor:pointer; margin-left:10px;" onclick="deleteSharedExpense(${idx})"></i>` : '';
                sharedHTML += `<div class="expense-row-list"><span>${exp.desc} ${delBtn}</span><span>${symbol}${parseFloat(exp.cost).toFixed(2)}</span></div>`;
            });
            if(currentUser.role === 'admin') {
                sharedHTML += `<button class="btn-primary" style="font-size:0.8rem; padding:0.5rem;" onclick="openModal('shared-expense-modal')">+ Gasto Compartido</button>`;
            }

            // Gastos Personales
            let personalHTML = `<h4 style="margin-bottom:10px; color:var(--primary); margin-top:20px;"><i class="fas fa-user-tag"></i> Mis Gastos Personales</h4>`;
            const personalTotal = personalExpenses.reduce((a, b) => a + parseFloat(b.cost), 0);
            personalHTML += `<div style="font-size:0.9rem; margin-bottom:5px;">Mi Total: ${symbol}${personalTotal.toFixed(2)}</div>`;

            personalExpenses.forEach((exp, idx) => {
                 personalHTML += `<div class="expense-row-list"><span>${exp.desc} <i class="fas fa-trash" style="color:red; cursor:pointer; margin-left:10px;" onclick="deletePersonalExpense(${idx})"></i></span><span>${symbol}${parseFloat(exp.cost).toFixed(2)}</span></div>`;
            });
            personalHTML += `<button class="btn-primary" style="font-size:0.8rem; padding:0.5rem; background:var(--primary);" onclick="openModal('personal-expense-modal')">+ Gasto Personal</button>`;

            container.innerHTML = `
                <div class="day-total-header">
                    <div class="day-title-section"><i class="far fa-calendar-alt"></i> ${capitalDate}</div>
                    <div class="totals-grid">
                        <div class="total-row"><span class="currency-label">USD</span><div class="currency-values"><span class="val-day">$${dayTotalUSD.toFixed(2)}</span> | <span class="val-trip">Viaje: $${tripTotals.usd.toFixed(2)}</span></div></div>
                        ${crcRate > 0 ? `<div class="total-row"><span class="currency-label">Col</span><div class="currency-values"><span class="val-day">â‚¡${dayTotalCRC.toLocaleString()}</span> | <span class="val-trip">Viaje: â‚¡${tripTotals.crc.toLocaleString()}</span></div></div>` : ''}
                        <div class="total-row"><span class="currency-label">${symbol}</span><div class="currency-values"><span class="val-day">${formatMoney(dayTotalLocal)}</span> | <span class="val-trip">Viaje: ${formatMoney(tripTotals.local)}</span></div></div>
                    </div>
                </div>

                <div class="shared-expenses-box">${sharedHTML}</div>
                <div class="personal-expenses-box">${personalHTML}</div>

                <ul class="activity-list">${renderActivitiesListHTML(day, activeDayIndex, symbol, rate, crcRate)}</ul>
                <button class="btn-add-activity" onclick="openModal('add', ${activeDayIndex})"><i class="fas fa-plus"></i> AÃ±adir Actividad</button>
                
                <div class="daily-expenses">
                    <div class="expense-title">Otros Gastos Diarios (${symbol})</div>
                    <div class="expense-grid">
                        <div class="expense-input"><label><i class="fas fa-utensils"></i> Comida</label><input type="number" min="0" step="0.5" value="${day.expenses.food}" onchange="updateExpense(${activeDayIndex}, 'food', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-bus"></i> Transporte</label><input type="number" min="0" step="0.5" value="${day.expenses.transport}" onchange="updateExpense(${activeDayIndex}, 'transport', this.value)"></div>
                        <div class="expense-input"><label><i class="fas fa-ticket-alt"></i> Entradas</label><input type="number" min="0" step="0.5" value="${day.expenses.tickets}" onchange="updateExpense(${activeDayIndex}, 'tickets', this.value)"></div>
                    </div>
                </div>
            `;
        }

        function renderActivitiesListHTML(day, dayIndex, symbol, rate, crcRate) {
            if (day.activities.length === 0) return `<li style="text-align:center; color:var(--gray); padding:2rem; border:1px dashed #ccc; border-radius:8px;">Sin actividades planeadas.</li>`;
            return day.activities.map((act, actIndex) => {
                // CLASES COLORES RESTAURADAS
                let iconClass = 'act-icon-general';
                if(['fa-utensils'].includes(act.icon)) iconClass = 'act-icon-food';
                if(['fa-bus','fa-taxi','fa-subway'].includes(act.icon)) iconClass = 'act-icon-transport';
                if(['fa-landmark','fa-university'].includes(act.icon)) iconClass = 'act-icon-culture';
                if(['fa-plane'].includes(act.icon)) iconClass = 'act-icon-travel';
                if(['fa-bed'].includes(act.icon)) iconClass = 'act-icon-lodging';
                if(['fa-tree'].includes(act.icon)) iconClass = 'act-icon-nature';
                if(['fa-shopping-bag'].includes(act.icon)) iconClass = 'act-icon-shopping';
                if(['fa-glass-cheers'].includes(act.icon)) iconClass = 'act-icon-party';

                const iconToDisplay = act.icon || 'fa-star';
                const costVal = parseFloat(act.cost);
                const currCode = act.currency || 'local'; 
                let originalSymbol = currCode === 'usd' ? '$' : (currCode === 'crc' ? 'â‚¡' : symbol);
                const costUSD = convertToUSD(costVal, currCode);
                const costCRC = costUSD * crcRate;
                const costLocal = costUSD * rate; 

                return `
                <li class="activity-item">
                    <div class="activity-top">
                        <div class="activity-time">${act.time}</div>
                        <div class="activity-details">
                            <div class="activity-name"><i class="fas ${iconToDisplay} ${iconClass}"></i> ${act.name}</div>
                            <div class="activity-meta"><i class="fas fa-map-marker-alt"></i> ${act.location}</div>
                            ${act.howToGet ? `<div class="activity-meta"><i class="fas fa-directions"></i> <span>${act.howToGet}</span></div>` : ''}
                            ${act.link ? `<div class="activity-meta"><i class="fas fa-globe"></i> <a href="${act.link}" target="_blank" class="activity-link">Visitar sitio web</a></div>` : ''}
                            <div style="margin-top: 8px;">
                                <div class="activity-meta" style="color: var(--dark); font-weight: bold; margin-bottom:2px;">
                                    <i class="fas fa-coins"></i> ${originalSymbol}${costVal.toFixed(2)} <span style="font-size:0.8em; font-weight:normal; color:var(--gray); text-transform:uppercase;">(${currCode})</span>
                                </div>
                                <div style="font-size:0.85em; color:var(--gray); padding-left: 20px;">
                                    <div>â†’ $${costUSD.toFixed(2)} USD</div>
                                    ${crcRate > 0 ? `<div>â†’ â‚¡${costCRC.toLocaleString()} Colones</div>` : ''}
                                    ${currCode !== 'local' ? `<div>â†’ ${formatMoney(costLocal)} ${symbol} (Equivalente)</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn-sm btn-edit" onclick="openModal('edit', ${dayIndex}, ${actIndex})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn-sm btn-delete" onclick="deleteActivity(${dayIndex}, ${actIndex})"><i class="fas fa-trash"></i> Borrar</button>
                    </div>
                </li>`;
            }).join('');
        }

        // --- LOGICA DE DATOS ---
        function convertToUSD(amount, currencyCode) {
            const val = parseFloat(amount) || 0;
            const code = currencyCode || 'local';
            const rate = appData.exchangeRate || 1;
            const crcRate = appData.crcRate || 0;
            if (code === 'usd') return val;
            if (code === 'crc') return val / crcRate;
            return val / rate;
        }

        function formatMoney(amount) {
            return parseFloat(amount).toFixed(2);
        }

        function updateExpense(dayIndex, type, value) {
            appData.days[dayIndex].expenses[type] = parseFloat(value) || 0;
            saveToStorage();
        }

        async function saveToStorage() {
            if(!currentTripId || !supabaseClient) return;
            await supabaseClient.from('trips')
                .update({ trip_data: appData, shared_expenses: sharedExpenses })
                .eq('id', currentTripId);
            await supabaseClient.from('user_trip_expenses')
                .upsert({ user_id: currentUser.id, trip_id: currentTripId, personal_expenses: personalExpenses });
            updateTotalCost();
            renderActiveDay();
        }

        // --- GESTION DE ACTIVIDADES ---
        function openModal(mode, dayIndex, actIndex = null) {
            const modalId = (mode === 'add' || mode === 'edit') ? 'activity-modal' : mode;
            document.getElementById(modalId).classList.add('active');
            
            if (modalId === 'activity-modal') {
                document.getElementById('modal-day-index').value = dayIndex;
                document.getElementById('modal-activity-index').value = actIndex !== null ? actIndex : '';
                const form = document.getElementById('activity-form');
                if (mode === 'edit' && actIndex !== null) {
                    document.getElementById('modal-title').textContent = 'Editar Actividad';
                    const act = appData.days[dayIndex].activities[actIndex];
                    document.getElementById('act-icon').value = act.icon || 'fa-star';
                    document.getElementById('act-time').value = act.time;
                    document.getElementById('act-name').value = act.name;
                    document.getElementById('act-location').value = act.location;
                    document.getElementById('act-transport').value = act.howToGet;
                    document.getElementById('act-link').value = act.link;
                    document.getElementById('act-cost').value = act.cost;
                    document.getElementById('act-currency').value = act.currency || 'local';
                } else {
                    document.getElementById('modal-title').textContent = 'AÃ±adir Actividad';
                    form.reset();
                    document.getElementById('act-icon').value = 'fa-star';
                    document.getElementById('act-cost').value = 0;
                    document.getElementById('act-currency').value = 'local';
                }
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        async function saveActivity(e) {
            e.preventDefault();
            const dayIndex = parseInt(document.getElementById('modal-day-index').value);
            const actIndexStr = document.getElementById('modal-activity-index').value;
            
            const activityData = {
                icon: document.getElementById('act-icon').value,
                time: document.getElementById('act-time').value,
                name: document.getElementById('act-name').value,
                location: document.getElementById('act-location').value,
                howToGet: document.getElementById('act-transport').value,
                link: document.getElementById('act-link').value,
                cost: parseFloat(document.getElementById('act-cost').value),
                currency: document.getElementById('act-currency').value 
            };

            if (actIndexStr !== '') {
                appData.days[dayIndex].activities[parseInt(actIndexStr)] = activityData;
            } else {
                appData.days[dayIndex].activities.push(activityData);
                appData.days[dayIndex].activities.sort((a, b) => a.time.localeCompare(b.time));
            }
            await saveToStorage();
            closeModal('activity-modal');
        }

        async function deleteActivity(dayIndex, actIndex) {
            if(confirm("Â¿Eliminar esta actividad?")) {
                appData.days[dayIndex].activities.splice(actIndex, 1);
                await saveToStorage();
            }
        }

        // --- GESTION GASTOS COMPARTIDOS (ADMIN) ---
        async function saveSharedExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('shared-desc').value;
            const cost = document.getElementById('shared-cost').value;
            sharedExpenses.push({ desc, cost });
            await saveToStorage();
            closeModal('shared-expense-modal');
        }
        async function deleteSharedExpense(idx) {
            if(confirm("Â¿Borrar gasto compartido?")) {
                sharedExpenses.splice(idx, 1);
                await saveToStorage();
            }
        }

        // --- GESTION GASTOS PERSONALES (USER) ---
        async function savePersonalExpense(e) {
            e.preventDefault();
            const desc = document.getElementById('personal-desc').value;
            const cost = document.getElementById('personal-cost').value;
            personalExpenses.push({ desc, cost });
            await saveToStorage();
            closeModal('personal-expense-modal');
        }
        async function deletePersonalExpense(idx) {
            if(confirm("Â¿Borrar gasto personal?")) {
                personalExpenses.splice(idx, 1);
                await saveToStorage();
            }
        }

        // --- GESTION USUARIOS (ADMIN) - ACTUALIZADO PARA EDITAR ---
        async function openUserModal() {
            clearUserForm();
            loadUsersList();
            openModal('users-modal');
        }

        async function loadUsersList() {
            const { data } = await supabaseClient.from('app_users').select('*');
            const list = document.getElementById('users-list-ul');
            list.innerHTML = '';
            
            data.forEach(u => {
                const li = document.createElement('li');
                li.className = 'user-list-item';
                li.innerHTML = `
                    <span onclick="editUser(${u.id})" style="flex:1; cursor:pointer; font-weight:600;">${u.full_name} <small style="font-weight:400; color:#888;">(${u.email})</small></span>
                    <div class="user-list-actions">
                        <span style="font-size:0.8rem; background:${u.role==='admin'?'#fff3cd':'#f1f2f6'}; padding:2px 6px; border-radius:4px;">${u.role}</span>
                        ${u.email !== 'admin@quinchitico.com' ? `<button class="btn-sm btn-delete" onclick="event.stopPropagation(); deleteUser(${u.id})"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function clearUserForm() {
            document.getElementById('edit-user-id').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-pass').value = '';
            document.querySelector('#users-modal form button[type="submit"]').innerText = 'Guardar Usuario';
        }

        async function editUser(id) {
            const { data } = await supabaseClient.from('app_users').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('edit-user-id').value = data.id;
                document.getElementById('user-name').value = data.full_name;
                document.getElementById('user-email').value = data.email;
                document.getElementById('user-pass').value = '';
                document.querySelector('#users-modal form button[type="submit"]').innerText = 'Actualizar Usuario';
                showToast('Editando usuario: ' + data.full_name, 'success');
            }
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-user-id').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;

            if(id) {
                const updateData = { full_name: name, email: email };
                if(pass) updateData.password = pass;
                
                const { error } = await supabaseClient.from('app_users').update(updateData).eq('id', id);
                if(error) showToast('Error actualizando', 'error');
                else {
                    showToast('Usuario actualizado', 'success');
                    clearUserForm();
                    loadUsersList();
                }
            } else {
                const { error } = await supabaseClient.from('app_users').insert({
                    full_name: name, email: email, password: pass, role: 'user'
                });
                if(error) showToast('Error creando', 'error');
                else {
                    showToast('Usuario creado', 'success');
                    clearUserForm();
                    loadUsersList();
                }
            }
        }

        async function deleteUser(id) {
            if(!confirm("Â¿Borrar este usuario?")) return;
            const { error } = await supabaseClient.from('app_users').delete().eq('id', id);
            if(error) showToast('Error borrando', 'error');
            else loadUsersList();
        }

        // --- RESUMEN ---
        function renderSummarySheet() {
            const container = document.getElementById('tab-content');
            const symbol = appData.currencySymbol;
            const rate = appData.exchangeRate;
            const crcRate = appData.crcRate || 0;
            const totals = calculateTripTotals();
            const breakdown = calculateCategoryBreakdown();

            const dailyTotals = appData.days.map((day, idx) => {
                let totalUSD = 0;
                day.activities.forEach(a => totalUSD += convertToUSD(a.cost, a.currency));
                totalUSD += (parseFloat(day.expenses.food || 0) / rate);
                totalUSD += (parseFloat(day.expenses.transport || 0) / rate);
                totalUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                return { idx: idx + 1, date: day.date, total: totalUSD };
            }).sort((a,b) => b.total - a.total);

            container.innerHTML = `
                <div class="summary-card">
                    <h2 class="summary-title">Resumen Financiero</h2>
                    <div class="big-totals">
                        <div class="big-total-item"><span class="bt-label">DÃ³lares (USD)</span><span class="bt-value">$${totals.usd.toFixed(2)}</span></div>
                        ${crcRate > 0 ? `<div class="big-total-item"><span class="bt-label">Colones (CRC)</span><span class="bt-value">â‚¡${totals.crc.toLocaleString()}</span></div>` : ''}
                        <div class="big-total-item"><span class="bt-label">${symbol} (Local)</span><span class="bt-value">${formatMoney(totals.local)}</span></div>
                    </div>
                    <div class="summary-grid">
                        <div class="breakdown-section">
                            <h3>Por CategorÃ­a</h3>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-utensils" style="color:#e17055;"></i> Comida</span><span class="cat-val">$${breakdown.foodUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-bus" style="color:#0984e3;"></i> Transporte</span><span class="cat-val">$${breakdown.transportUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-ticket-alt" style="color:#fdcb6e;"></i> Entradas</span><span class="cat-val">$${breakdown.ticketsUSD.toFixed(2)}</span></div>
                            <div class="breakdown-row"><span class="cat-name"><i class="fas fa-list" style="color:#b2bec3;"></i> Actividades</span><span class="cat-val">$${breakdown.activitiesUSD.toFixed(2)}</span></div>
                        </div>
                        <div class="breakdown-section">
                            <h3>DÃ­as mÃ¡s costosos</h3>
                            ${dailyTotals.map(d => `<div class="breakdown-row"><span class="cat-name">DÃ­a ${d.idx}</span><span class="cat-val">$${d.total.toFixed(2)}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function calculateCategoryBreakdown() {
            let foodUSD = 0, transportUSD = 0, ticketsUSD = 0, activitiesUSD = 0;
            const rate = appData.exchangeRate || 1;
            appData.days.forEach(day => {
                foodUSD += (parseFloat(day.expenses.food || 0) / rate);
                transportUSD += (parseFloat(day.expenses.transport || 0) / rate);
                ticketsUSD += (parseFloat(day.expenses.tickets || 0) / rate);
                day.activities.forEach(act => { activitiesUSD += convertToUSD(act.cost, act.currency); });
            });
            return { foodUSD, transportUSD, ticketsUSD, activitiesUSD };
        }

        function calculateTripTotals() {
            let grandTotalUSD = 0;
            const rate = appData.exchange
